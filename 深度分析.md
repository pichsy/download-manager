# Downloadåº“æ·±åº¦ç¼ºé™·åˆ†ææŠ¥å‘Š

## ğŸ” ä»»åŠ¡å…¥å£åˆ°æ•°æ®å…¥åº“å®Œæ•´æµç¨‹åˆ†æ

### 1. ä»»åŠ¡å…¥å£æµç¨‹ç¼ºé™·åˆ†æ

#### 1.1 ä»»åŠ¡åˆ›å»ºä¸å…¥å£ç¼ºé™·

**æµç¨‹è·¯å¾„**: `Downloader.Builder.build()` â†’ `DownloadTask.pushTask()` â†’ `DownloadQueueDispatcher.pushTask()`

**å‘ç°çš„ç¼ºé™·**:

1. **ä»»åŠ¡IDç”Ÿæˆä¸å®‰å…¨** (Downloader.kt:161-166)
   ```kotlin
   // é—®é¢˜ï¼šå¤šä¸ªBuilderå¹¶å‘buildå¯èƒ½å¯¼è‡´é‡å¤taskId
   if (this.downloadInfo?.taskId.isNullOrEmpty()) {
       this.downloadInfo?.taskId = TaskIdUtils.generateTaskId(...)
   }
   ```
   **é£é™©**: å¹¶å‘æƒ…å†µä¸‹å¯èƒ½ç”Ÿæˆé‡å¤taskId

2. **é‡å¤ä»»åŠ¡æ£€æŸ¥ä¸å®Œæ•´** (DownloadQueueDispatcher.kt:67-84)
   ```kotlin
   // é—®é¢˜ï¼šåªæ£€æŸ¥taskIdï¼Œæœªæ£€æŸ¥URL+æ–‡ä»¶è·¯å¾„ç»„åˆ
   if (!isTaskExists(task.getTaskId())) {
       // å…è®¸é‡å¤æ·»åŠ 
   } else {
       // todo å¦‚æœå·²ç»å­˜åœ¨ï¼Œåˆ™ä¸éœ€è¦å†æ¬¡æ·»åŠ 
   }
   ```
   **é£é™©**: ç›¸åŒURLå’Œè·¯å¾„çš„ä»»åŠ¡å¯ä»¥é‡å¤æ·»åŠ ï¼Œåªæ˜¯taskIdä¸åŒ

#### 1.2 åˆå§‹åŒ–çŠ¶æ€ç¼ºé™·

**é—®é¢˜**: ä»»åŠ¡çŠ¶æ€è®¾ç½®æ—¶æœºä¸å½“
```kotlin
// DownloadQueueDispatcher.kt:68
task.downloadInfo?.status = DownloadStatus.WAITING
// é—®é¢˜ï¼šæ­¤æ—¶ä»»åŠ¡ä¿¡æ¯å°šæœªæŒä¹…åŒ–ï¼Œåº”ç”¨å´©æºƒä¼šä¸¢å¤±
```

### 2. æ•°æ®æµè½¬è·¯å¾„åˆ†æ

#### 2.1 å®Œæ•´æ•°æ®æµ

```
DownloadTaskåˆ›å»º
    â†“
DownloadQueueDispatcher.pushTask() [å†…å­˜æ“ä½œ]
    â†“
DownloadMultiCall.startCall() [å¼‚æ­¥å¼€å§‹]
    â†“
getOrCreateBreakpointData() [é¦–æ¬¡å…¥åº“]
    â†“
getOrCreateChunk() [åˆ†å—ä¿¡æ¯å…¥åº“]
    â†“
ä¸‹è½½å¾ªç¯ä¸­ [å®šæœŸæ›´æ–°]
    â†“
updateBreakPointData() [è¿›åº¦æ›´æ–°]
    â†“
onDownloadComplete()/onDownloadFailed() [æ¸…ç†æ•°æ®]
```

#### 2.2 æ•°æ®ä¸€è‡´æ€§ç¼ºé™·

**è‡´å‘½ç¼ºé™·**: æ•°æ®çŠ¶æ€ä¸ä¸€è‡´

1. **å†…å­˜ä¸æ•°æ®åº“çŠ¶æ€ä¸åŒæ­¥**
   ```kotlin
   // DownloadMultiCall.kt:140
   task.downloadInfo?.apply {
       this.status = 1 // åªåœ¨å†…å­˜ä¸­ä¿®æ”¹
   }
   // æ•°æ®åº“ä¸­çš„DownloadBreakPointData.statusæœªæ›´æ–°
   ```

2. **äº‹åŠ¡æ€§ç¼ºå¤±**
   - æ–­ç‚¹ä¿¡æ¯æ›´æ–°å’Œåˆ†å—ä¿¡æ¯æ›´æ–°æ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰åŸå­æ€§ä¿è¯
   - åº”ç”¨å´©æºƒå¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

### 3. æ•°æ®å…¥åº“å®Œæ•´æ€§åˆ†æ

#### 3.1 æ•°æ®åº“æ“ä½œç¼ºé™·

**3.1.1 æ–­ç‚¹æ•°æ®å…¥åº“é—®é¢˜**

```kotlin
// DownloadMultiCall.kt:237-255
private suspend fun getOrCreateBreakpointData(...): DownloadBreakPointData {
    val existingInfo = DownloadBreakPointManger.queryByTaskId(taskId)
    return if (existingInfo != null) {
        existingInfo  // é—®é¢˜ï¼šè¿”å›æ—§æ•°æ®ï¼Œä½†currentLengthå¯èƒ½å·²å˜åŒ–
    } else {
        val newInfo = DownloadBreakPointData(...)
        DownloadBreakPointManger.upsert(newInfo)  // å¼‚æ­¥æ“ä½œï¼Œæ— è¿”å›å€¼æ£€æŸ¥
        newInfo
    }
}
```

**é—®é¢˜**:
- `upsert`è¿”å›å€¼æœªæ£€æŸ¥ï¼Œå¯èƒ½æ’å…¥å¤±è´¥ä½†ç»§ç»­æ‰§è¡Œ
- è¿”å›çš„`existingInfo`å¯èƒ½å·²è¿‡æœŸ

**3.1.2 åˆ†å—æ•°æ®å…¥åº“é—®é¢˜**

```kotlin
// DownloadMultiCall.kt:257-278
private suspend fun getOrCreateChunk(...): DownloadChunk {
    return chunks?.find { it.chunkIndex == index } ?: run {
        DownloadChunk(...).also {
            DownloadChunkManager.upsert(it)  // å¼‚æ­¥æ“ä½œï¼Œå¼‚å¸¸è¢«åæ‰
        }
    }
}
```

**é—®é¢˜**:
- `upsert`å¼‚å¸¸è¢«`DownloadChunkManager`åæ‰ï¼Œè°ƒç”¨æ–¹æ— æ³•æ„ŸçŸ¥å¤±è´¥
- åˆ†å—åˆ›å»ºå¤±è´¥æ—¶ç»§ç»­æ‰§è¡Œï¼Œå¯¼è‡´æ•°æ®ä¸å®Œæ•´

#### 3.2 æ•°æ®å®Œæ•´æ€§ç¼ºé™·

**3.2.1 ä¸»é”®å†²çªå¤„ç†**

```kotlin
// DownloadChunkçš„æ•°æ®ç»“æ„
@Entity(tableName = ..., primaryKeys = ["taskId", "chunkIndex"])
```

**é—®é¢˜**: å½“taskId+chunkIndexå·²å­˜åœ¨æ—¶ï¼Œ`@Upsert`ä¼šæ›´æ–°ç°æœ‰è®°å½•ï¼Œä½†å¯èƒ½å¯¼è‡´å·²ä¸‹è½½æ•°æ®è¢«é‡ç½®

**3.2.2 å¤–é”®çº¦æŸç¼ºå¤±**

**é—®é¢˜**: æ²¡æœ‰å¤–é”®çº¦æŸä¿è¯DownloadChunk.taskIdå¿…é¡»åœ¨DownloadBreakPointDataä¸­å­˜åœ¨

### 4. å¹¶å‘å’Œå¼‚å¸¸å¤„ç†ç¼ºé™·

#### 4.1 å¹¶å‘å®‰å…¨é—®é¢˜

**4.1.1 ç«æ€æ¡ä»¶**

```kotlin
// DownloadMultiCall.kt:142-147
launch {
    DownloadChunkManager.upsert(chunkUpdate)
    updateBreakPointData(breakpointInfo, currentBytes)
}
```

**é—®é¢˜**: 
- ä¸¤ä¸ªæ•°æ®åº“æ“ä½œä¸æ˜¯åŸå­æ€§çš„
- å¹¶å‘æƒ…å†µä¸‹å¯èƒ½å¯¼è‡´æ•°æ®ä¸ä¸€è‡´

**4.1.2 å†…å­˜å¯è§æ€§é—®é¢˜**

```kotlin
// DownloadQueueDispatcher.kt:52-54
private val allActivatedDownloadCall = Collections.synchronizedList(mutableListOf<DownloadMultiCall>())
```

**é—®é¢˜**: 
- è™½ç„¶åˆ—è¡¨æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œä½†DownloadTaskå†…éƒ¨çš„DownloadTaskInfoä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„
- å¤šä¸ªçº¿ç¨‹åŒæ—¶ä¿®æ”¹DownloadTaskInfoå¯èƒ½å¯¼è‡´æ•°æ®ç«äº‰

#### 4.2 å¼‚å¸¸å¤„ç†ç¼ºé™·

**4.2.1 å¼‚å¸¸åæ‰**

```kotlin
// DownloadBreakPointManger.kt:13-19
suspend fun upsert(data: DownloadBreakPointData) = withContext(Dispatchers.IO) {
    try {
        getDao().upsert(data)
    } catch (e: Exception) {
        -1L  // å¼‚å¸¸è¢«åæ‰ï¼Œè°ƒç”¨æ–¹æ— æ³•æ„ŸçŸ¥
    }
}
```

**4.2.2 æ¸…ç†æ“ä½œç¼ºé™·**

```kotlin
// DownloadMultiCall.kt:291-296
private suspend fun onDownloadComplete(task: DownloadTask) {
    DownloadBreakPointManger.deleteByTaskId(task.downloadInfo?.taskId ?: "")
    DownloadChunkManager.deleteChunkByTaskId(task.downloadInfo?.taskId ?: "")
    // é—®é¢˜ï¼šåˆ é™¤æ“ä½œæ˜¯å¼‚æ­¥çš„ï¼Œå¯èƒ½å¤±è´¥ä½†æœªå¤„ç†
}
```

### 5. æ•°æ®ä¸€è‡´æ€§éªŒè¯ç¼ºå¤±

#### 5.1 å®Œæ•´æ€§æ£€æŸ¥ç¼ºå¤±

**é—®é¢˜**: æ²¡æœ‰æ•°æ®å®Œæ•´æ€§éªŒè¯æœºåˆ¶

```kotlin
// åº”è¯¥æœ‰çš„éªŒè¯
1. ä¸‹è½½å‰éªŒè¯æ–­ç‚¹æ•°æ®ä¸æ–‡ä»¶å®é™…å¤§å°æ˜¯å¦ä¸€è‡´
2. ä¸‹è½½ä¸­éªŒè¯å·²ä¸‹è½½å­—èŠ‚æ•°ä¸æ•°æ®åº“è®°å½•æ˜¯å¦ä¸€è‡´
3. ä¸‹è½½åéªŒè¯æ–‡ä»¶å®Œæ•´æ€§
4. åº”ç”¨å¯åŠ¨æ—¶éªŒè¯æ•°æ®åº“ä¸€è‡´æ€§
```

#### 5.2 äº‹åŠ¡è¾¹ç•Œé—®é¢˜

**é—®é¢˜**: æ²¡æœ‰äº‹åŠ¡è¾¹ç•Œå®šä¹‰

- ä»»åŠ¡çŠ¶æ€æ›´æ–°å’Œæ–‡ä»¶æ“ä½œä¸åœ¨åŒä¸€äº‹åŠ¡ä¸­
- æ•°æ®åº“æ“ä½œå’Œæ–‡ä»¶ç³»ç»Ÿæ“ä½œæ— æ³•å›æ»š
- éƒ¨åˆ†æˆåŠŸéƒ¨åˆ†å¤±è´¥çš„æƒ…å†µæ— æ³•å¤„ç†

## ğŸš¨ å…³é”®ç¼ºé™·æ€»ç»“

### Açº§ç¼ºé™· (å¯èƒ½å¯¼è‡´æ•°æ®ä¸¢å¤±)

1. **çŠ¶æ€ä¸åŒæ­¥**: å†…å­˜çŠ¶æ€ä¸æ•°æ®åº“çŠ¶æ€ä¸ä¸€è‡´
2. **äº‹åŠ¡ç¼ºå¤±**: å…³é”®æ“ä½œæ²¡æœ‰åŸå­æ€§ä¿è¯
3. **å¼‚å¸¸åæ‰**: æ•°æ®åº“æ“ä½œå¤±è´¥è¢«å¿½ç•¥
4. **ç«æ€æ¡ä»¶**: å¹¶å‘æ“ä½œå¯èƒ½å¯¼è‡´æ•°æ®æŸå

### Bçº§ç¼ºé™· (å¯èƒ½å¯¼è‡´åŠŸèƒ½å¼‚å¸¸)

1. **é‡å¤ä»»åŠ¡**: ä»»åŠ¡é‡å¤æ£€æŸ¥ä¸å®Œæ•´
2. **æ•°æ®è¿‡æœŸ**: ä½¿ç”¨è¿‡æœŸæ•°æ®ç»§ç»­ä¸‹è½½
3. **æ¸…ç†å¤±è´¥**: å®Œæˆåçš„æ¸…ç†æ“ä½œå¯èƒ½å¤±è´¥
4. **ä¸»é”®å†²çª**: åˆ†å—æ•°æ®å¯èƒ½æ„å¤–è¦†ç›–

### Cçº§ç¼ºé™· (å½±å“ç”¨æˆ·ä½“éªŒ)

1. **åˆå§‹åŒ–ç¼ºé™·**: ä»»åŠ¡çŠ¶æ€è®¾ç½®æ—¶æœºä¸å½“
2. **éªŒè¯ç¼ºå¤±**: ç¼ºä¹æ•°æ®å®Œæ•´æ€§éªŒè¯
3. **æ—¥å¿—ä¸è¶³**: å…³é”®æ“ä½œç¼ºä¹æ—¥å¿—è®°å½•

## ğŸ”§ ä¿®å¤å»ºè®®

### ç«‹å³ä¿®å¤

1. **æ·»åŠ äº‹åŠ¡æ”¯æŒ**
   ```kotlin
   // ä½¿ç”¨Roomäº‹åŠ¡
   @Transaction
   suspend fun updateDownloadProgress(taskId: String, currentLength: Long, chunks: List<DownloadChunk>) {
       // åŸå­æ€§æ›´æ–°æ–­ç‚¹å’Œåˆ†å—ä¿¡æ¯
   }
   ```

2. **çŠ¶æ€åŒæ­¥**
   ```kotlin
   // æ¯æ¬¡çŠ¶æ€å˜æ›´éƒ½åŒæ­¥åˆ°æ•°æ®åº“
   suspend fun updateTaskStatus(taskId: String, status: Int) {
       task.downloadInfo?.status = status
       // ç«‹å³æ›´æ–°æ•°æ®åº“
       updateBreakPointData(breakpointInfo.copy(status = status))
   }
   ```

3. **å¼‚å¸¸å¤„ç†**
   ```kotlin
   // ä¸è¦åæ‰å¼‚å¸¸ï¼Œè®©è°ƒç”¨æ–¹å¤„ç†
   suspend fun upsert(data: DownloadBreakPointData): Result<Long> = runCatching {
       getDao().upsert(data)
   }
   ```

### æ¶æ„æ”¹è¿›

1. **æ·»åŠ æ•°æ®å±‚**: åˆ›å»ºRepositoryå±‚ç»Ÿä¸€å¤„ç†æ•°æ®æ“ä½œ
2. **æ·»åŠ äº‹åŠ¡ç®¡ç†**: ä½¿ç”¨æ•°æ®åº“äº‹åŠ¡ä¿è¯æ“ä½œåŸå­æ€§
3. **æ·»åŠ çŠ¶æ€æœº**: ä½¿ç”¨çŠ¶æ€æœºç®¡ç†ä»»åŠ¡ç”Ÿå‘½å‘¨æœŸ
4. **æ·»åŠ ä¸€è‡´æ€§æ£€æŸ¥**: å®šæœŸéªŒè¯æ•°æ®å®Œæ•´æ€§

### ç›‘æ§å’ŒéªŒè¯

1. **æ·»åŠ æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥**: å¯åŠ¨æ—¶éªŒè¯æ•°æ®åº“ä¸æ–‡ä»¶ç³»ç»Ÿä¸€è‡´æ€§
2. **æ·»åŠ æ“ä½œæ—¥å¿—**: è®°å½•æ‰€æœ‰å…³é”®æ•°æ®æ“ä½œ
3. **æ·»åŠ å¼‚å¸¸ç›‘æ§**: ç»Ÿè®¡æ•°æ®åº“æ“ä½œå¤±è´¥ç‡
4. **æ·»åŠ å¥åº·æ£€æŸ¥**: å®šæœŸæ£€æŸ¥æ•°æ®å®Œæ•´æ€§