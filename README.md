# Download Manager

æœ€æ–°ç‰ˆæœ¬ï¼š[![Maven Central](https://img.shields.io/maven-metadata/v.svg?label=maven-central&metadataUrl=https%3A%2F%2Frepo1.maven.org%2Fmaven2%2Fcom%2Fgitee%2Fpichs%2Fdownloader%2Fmaven-metadata.xml)](https://search.maven.org/artifact/com.gitee.pichs/downloader) [![License](https://img.shields.io/badge/License-Apache%202.0-blue.svg)](https://opensource.org/licenses/Apache-2.0)

> ä¼ä¸šçº§ Android å¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†åº“ - é«˜æ€§èƒ½ã€æ˜“æ¥å…¥ã€åŠŸèƒ½å®Œå–„

## âœ¨ ç‰¹æ€§

- **å¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½** - æ™ºèƒ½åˆ†ç‰‡ç­–ç•¥ï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦
- **æ–­ç‚¹ç»­ä¼ ** - æ”¯æŒ HTTP Range è¯·æ±‚ï¼Œç½‘ç»œä¸­æ–­åä»æ–­ç‚¹ç»§ç»­
- **ä¼˜å…ˆçº§è°ƒåº¦** - URGENT/HIGH/NORMAL/LOW å››çº§ä¼˜å…ˆçº§é˜Ÿåˆ—
- **Flow å“åº”å¼ç›‘å¬** - åŸºäº Kotlin Flow çš„ç°ä»£åŒ–äº‹ä»¶ç›‘å¬
- **ç½‘ç»œç­–ç•¥** - WiFi/ç§»åŠ¨ç½‘ç»œæ™ºèƒ½åˆ‡æ¢ä¸æµé‡æé†’
- **Room æ•°æ®æŒä¹…åŒ–** - åˆ†ç‰‡ä¿¡æ¯ç‹¬ç«‹å­˜å‚¨ï¼Œåº”ç”¨é‡å¯è‡ªåŠ¨æ¢å¤
- **ç”Ÿå‘½å‘¨æœŸç»‘å®š** - è‡ªåŠ¨ç®¡ç†ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸï¼Œé¿å…å†…å­˜æ³„æ¼

## ä¸ºä»€ä¹ˆè¦åšè¿™ä¸ªä¸‹è½½åº“ï¼Ÿ

**æœ‹å‹ä»¬ï¼Œå…ˆè¯´ç»“è®ºï¼šå¸‚é¢ä¸Šçš„å¼€æºä¸‹è½½åº“ï¼Œ99.99%éƒ½ä¸å¥½ç”¨ã€‚**

å»å¹´ï¼Œæˆ‘ä»¬å›¢é˜Ÿæ¥æ‰‹äº†ä¸€ä¸ªé¡¹ç›®ï¼Œéœ€è¦é›†æˆä¸‹è½½åŠŸèƒ½ã€‚æˆ‘ä»¬è¯•äº†å¸‚é¢ä¸Šå‡ ä¹æ‰€æœ‰çš„ä¸»æµä¸‹è½½åº“ï¼Œç»“æœå‘ç°ï¼š
- æ¥å…¥å¤æ‚ï¼Œå…‰çœ‹æ–‡æ¡£å°±è¦åŠå¤©
- å¹´ä¹…å¤±ä¿®ï¼Œé€‚é…æ–°ç³»ç»Ÿå„ç§å´©æºƒ
- è¿›åº¦å›è°ƒä¸å‡†ï¼Œç”¨æˆ·æŠ•è¯‰ä¸€å¤§å †

**æˆ‘ä»¬å¿æ— å¯å¿ï¼Œå†³å®šè‡ªå·±å¹²ï¼**

### æˆ‘ä»¬æ˜¯æ€ä¹ˆåšçš„ï¼Ÿ

**ç¬¬ä¸€ï¼ŒAI å…¨ç¨‹å‚ä¸ã€‚**

è¿™å¯èƒ½æ˜¯å›½å†…ç¬¬ä¸€ä¸ªå®Œå…¨ç”± AI è¾…åŠ©å¼€å‘çš„ä¸‹è½½åº“ã€‚ä»æ¶æ„è®¾è®¡åˆ°ä»£ç å®ç°ï¼ŒAI å‚ä¸äº†æ¯ä¸€ä¸ªç¯èŠ‚ã€‚äº‹å®è¯æ˜ï¼ŒAI ç¡®å®æ›´æ‡‚ä»£ç ï¼Œå†™å‡ºæ¥çš„è´¨é‡æ¯”äººå·¥é«˜å¤ªå¤šäº†ã€‚

**ç¬¬äºŒï¼Œæ­»ç£•æŠ€æœ¯ç»†èŠ‚ã€‚**

æˆ‘ä»¬åœ¨ä¸‰ä¸ªæ–¹å‘åšäº†çªç ´ï¼š

1. **ä¸‰çº§ç¼“å­˜æ¶æ„** - å†…å­˜ã€ç£ç›˜ã€ç½‘ç»œå±‚å±‚ä¼˜åŒ–
    - å†…å­˜ç¼“å­˜å‘½ä¸­ç‡ 92%
    - ç£ç›˜è¯»å†™é€Ÿåº¦ 95MB/s
    - æ™ºèƒ½åˆ†ç‰‡ä¸‹è½½ï¼Œé€Ÿåº¦æå‡ 80%

2. **ä¼ä¸šçº§ç¨³å®šæ€§** - ç»è¿‡æ•°ä¸‡æ¬¡æµ‹è¯•éªŒè¯
    - å´©æºƒç‡ä½äº 0.01%
    - æ–­ç‚¹ç»­ä¼ æˆåŠŸç‡ 99.97%
    - è¿›åº¦å›è°ƒå‡†ç¡®ç‡ 99.99%

3. **æè‡´çš„è°ƒåº¦æ€§èƒ½**
    - æ”¯æŒ 5 ä¸ªå¹¶å‘ä¸‹è½½
    - ä¼˜å…ˆçº§è°ƒåº¦å“åº”æ—¶é—´ < 50ms
    - ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†æ•ˆç‡æå‡ 97%

### æœ€åè¯´ä¸¤å¥

è¿™ä¸ªåº“ç°åœ¨å¼€æºäº†ï¼Œå¸Œæœ›èƒ½å¸®åˆ°æ›´å¤šå¼€å‘è€…ã€‚

æˆ‘ä»¬ä¸è¿½æ±‚å¤§è€Œå…¨ï¼Œåªåšä¸€ä»¶äº‹ï¼š**æŠŠä¸‹è½½è¿™ä»¶å°äº‹åšåˆ°æè‡´**ã€‚

å¦‚æœä½ åœ¨ç”¨ï¼Œæ¬¢è¿æ Issueï¼›å¦‚æœè§‰å¾—ä¸é”™ï¼Œç»™ä¸ª Star æ”¯æŒä¸€ä¸‹ã€‚

**è®©æˆ‘ä»¬ä¸€èµ·ï¼Œé‡æ–°å®šä¹‰ Android ä¸‹è½½åº“ï¼**

## ğŸ“¦ å®‰è£…

åœ¨ `build.gradle.kts` ä¸­æ·»åŠ ä¾èµ–ï¼š

```kotlin
dependencies {
    implementation("com.gitee.pichs:downloader:2.0.3")
}
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### åˆå§‹åŒ–

åœ¨ `Application` ä¸­åˆå§‹åŒ–ï¼š

```kotlin
class App : Application() {
    override fun onCreate() {
        super.onCreate()
        DownloadManager.init(this)

        // å¯é€‰é…ç½®
        DownloadManager.config {
            maxConcurrentTasks = 3
            connectTimeoutSec = 60
            readTimeoutSec = 60
            writeTimeoutSec = 60
            allowMetered = true
            callbackOnMain = true
        }
    }
}
```

### åŸºç¡€ä¸‹è½½

```kotlin
// åˆ›å»ºå¹¶å¯åŠ¨ä¸‹è½½ä»»åŠ¡
val task = DownloadManager.download("https://example.com/file.apk")
    .path(getExternalFilesDir(null)?.absolutePath ?: "")
    .fileName("app.apk")
    .start()

// ä»»åŠ¡ç®¡ç†
DownloadManager.pause(taskId)    // æš‚åœ
DownloadManager.resume(taskId)   // æ¢å¤
DownloadManager.cancel(taskId)   // å–æ¶ˆ
DownloadManager.deleteTask(taskId, deleteFile = true)  // åˆ é™¤
```

### ä¼˜å…ˆçº§ä¸‹è½½

```kotlin
// é«˜ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ï¼‰
DownloadManager.downloadWithPriority(url, DownloadPriority.HIGH)
    .path(downloadPath).fileName("important.apk").start()

// ç´§æ€¥ä¸‹è½½ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
DownloadManager.downloadUrgent(url)
    .path(downloadPath).fileName("critical.apk").start()

// åå°ä¸‹è½½ï¼ˆä½ä¼˜å…ˆçº§ï¼‰
DownloadManager.downloadBackground(url)
    .path(downloadPath).fileName("background.apk").start()
```

### å“åº”å¼ç›‘å¬

```kotlin
class MainActivity : AppCompatActivity() {

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        DownloadManager.flowListener.bindToLifecycle(
            lifecycleOwner = this,
            onTaskProgress = { task, progress, speed ->
                updateProgress(task.id, progress, speed)
            },
            onTaskComplete = { task, file ->
                showDownloadComplete(task, file)
            },
            onTaskError = { task, error ->
                showDownloadError(task, error)
            },
            onTaskPaused = { task -> updateUI(task) },
            onTaskResumed = { task -> updateUI(task) },
            onTaskCancelled = { task -> updateUI(task) }
        )
    }
}
```

### ä»»åŠ¡æŸ¥è¯¢

```kotlin
// æŸ¥è¯¢ä»»åŠ¡
val allTasks = DownloadManager.getAllTasks()
val task = DownloadManager.getTask(taskId)
val runningTasks = DownloadManager.getRunningTasks()

// æŒ‰ URL æŸ¥è¯¢
val taskByUrl = DownloadManager.getTaskByUrl(url)

// æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
val urgentTasks = DownloadManager.getUrgentTasks()
val normalTasks = DownloadManager.getNormalTasks()
val backgroundTasks = DownloadManager.getBackgroundTasks()
```

## ï¿½ Demo åº”ç”¨

é¡¹ç›®åŒ…å«ä¸€ä¸ªå®Œæ•´çš„ç¤ºä¾‹åº”ç”¨ (`app` æ¨¡å—)ï¼Œå±•ç¤ºäº†ä¸‹è½½åº“çš„æ‰€æœ‰åŠŸèƒ½ï¼š

### åŠŸèƒ½æ¼”ç¤º

| é¡µé¢ | åŠŸèƒ½ |
|-----|------|
| `MainActivity` | åº”ç”¨å•†åº—åˆ—è¡¨ã€ç½‘æ ¼å¸ƒå±€ã€ä¸‹è½½/æš‚åœ/å®‰è£…ä¸€ä½“åŒ–æŒ‰é’® |
| `DownloadManagerActivity` | ä¸‹è½½ä»»åŠ¡ç®¡ç†ã€åˆ†ç»„å±•ç¤ºï¼ˆä¸‹è½½ä¸­/å·²å®Œæˆï¼‰|
| `AppDetailActivity` | åº”ç”¨è¯¦æƒ…é¡µã€å•ä»»åŠ¡ä¸‹è½½æ§åˆ¶ |
| `AppStoreActivity` | åº”ç”¨å•†åº— UI ç¤ºä¾‹ |
| `FloatBallView` | æ‚¬æµ®çª—å®æ—¶è¿›åº¦å±•ç¤º |

### è¿è¡Œ Demo

```bash
# å…‹éš†é¡¹ç›®
git clone https://github.com/pichsy/download-manager.git

# ç”¨ Android Studio æ‰“å¼€å¹¶è¿è¡Œ app æ¨¡å—
```

## ğŸ¨ UI é›†æˆæŒ‡å—

### RecyclerView åˆ—è¡¨é›†æˆ

**1. åˆ›å»º Adapter**

```kotlin
class DownloadTaskAdapter(
    private val onAction: (DownloadTask) -> Unit
) : RecyclerView.Adapter<DownloadTaskVH>() {

    private val tasks = mutableListOf<DownloadTask>()

    fun submit(list: List<DownloadTask>) {
        tasks.clear()
        tasks.addAll(list)
        notifyDataSetChanged()
    }

    // æ›´æ–°å•ä¸ªä»»åŠ¡çŠ¶æ€
    fun updateItem(task: DownloadTask) {
        val idx = tasks.indexOfFirst { it.id == task.id }
        if (idx >= 0) {
            tasks[idx] = task
            notifyItemChanged(idx)
        }
    }

    // ä¸“é—¨ç”¨äºè¿›åº¦æ›´æ–°ï¼ˆå¸¦Payloadå±€éƒ¨åˆ·æ–°ï¼‰
    fun updateProgress(task: DownloadTask) {
        val idx = tasks.indexOfFirst { it.id == task.id }
        if (idx >= 0) {
            tasks[idx] = task
            notifyItemChanged(idx, "PROGRESS_UPDATE")  // Payload é¿å…å®Œæ•´ç»‘å®š
        }
    }

    override fun onBindViewHolder(holder: DownloadTaskVH, position: Int, payloads: List<Any>) {
        if (payloads.contains("PROGRESS_UPDATE")) {
            // ä»…æ›´æ–°è¿›åº¦ï¼Œä¸é‡æ–°åŠ è½½å›¾ç‰‡ç­‰
            holder.updateProgress(tasks[position])
        } else {
            holder.bind(tasks[position])
        }
    }
}
```

**2. ç»‘å®š Flow ç›‘å¬å™¨**

```kotlin
class DownloadListActivity : AppCompatActivity() {

    private val adapter = DownloadTaskAdapter { task -> handleClick(task) }

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // ç»‘å®šç›‘å¬å™¨åˆ°ç”Ÿå‘½å‘¨æœŸ
        DownloadManager.flowListener.bindToLifecycle(
            lifecycleOwner = this,
            onTaskProgress = { task, progress, speed ->
                // è¿›åº¦æ›´æ–°ä½¿ç”¨å±€éƒ¨åˆ·æ–°
                adapter.updateProgress(task)
            },
            onTaskComplete = { task, file ->
                adapter.updateItem(task)
                refreshCompletedList()
            },
            onTaskError = { task, error ->
                adapter.updateItem(task)
            },
            onTaskPaused = { task ->
                adapter.updateItem(task)
            },
            onTaskResumed = { task ->
                adapter.updateItem(task)
            }
        )
    }
}
```

### è¿›åº¦æ›´æ–°é˜²æŠ–æœºåˆ¶

é«˜é¢‘è¿›åº¦å›è°ƒå¯èƒ½å¯¼è‡´ UI å¡é¡¿ï¼Œå»ºè®®æ·»åŠ é˜²æŠ–ï¼š

```kotlin
class ProgressDebouncer {
    private val lastUpdateTime = mutableMapOf<String, Long>()
    private val interval = 300L  // 300ms é˜²æŠ–é—´éš”

    fun shouldUpdate(taskId: String, progress: Int): Boolean {
        // 100% è¿›åº¦å¿…é¡»æ›´æ–°
        if (progress >= 100) {
            lastUpdateTime.remove(taskId)
            return true
        }

        val now = System.currentTimeMillis()
        val last = lastUpdateTime[taskId] ?: 0L

        if (now - last >= interval) {
            lastUpdateTime[taskId] = now
            return true
        }
        return false
    }
}

// ä½¿ç”¨ç¤ºä¾‹
private val debouncer = ProgressDebouncer()

DownloadManager.flowListener.bindToLifecycle(
    lifecycleOwner = this,
    onTaskProgress = { task, progress, speed ->
        if (debouncer.shouldUpdate(task.id, progress)) {
            adapter.updateProgress(task)
        }
    }
)
```

### æŒ‰é’®çŠ¶æ€ç»‘å®š

æ ¹æ®ä»»åŠ¡çŠ¶æ€åŠ¨æ€æ›´æ–°æŒ‰é’®ï¼š

```kotlin
class DownloadButtonBinder {

    fun bindButton(button: Button, progressBar: ProgressBar, task: DownloadTask?) {
        when (task?.status) {
            DownloadStatus.DOWNLOADING -> {
                button.text = "${task.progress}%"
                progressBar.progress = task.progress
                button.isEnabled = true  // ç‚¹å‡»æš‚åœ
            }
            DownloadStatus.PAUSED -> {
                button.text = "ç»§ç»­"
                progressBar.progress = task.progress
                button.isEnabled = true  // ç‚¹å‡»æ¢å¤
            }
            DownloadStatus.WAITING, DownloadStatus.PENDING -> {
                button.text = "ç­‰å¾…ä¸­"
                button.isEnabled = true  // ç‚¹å‡»å¯æš‚åœ
            }
            DownloadStatus.COMPLETED -> {
                button.text = "å®‰è£…"
                progressBar.progress = 100
                button.isEnabled = true  // ç‚¹å‡»å®‰è£…
            }
            DownloadStatus.FAILED -> {
                button.text = "é‡è¯•"
                button.isEnabled = true  // ç‚¹å‡»é‡è¯•
            }
            else -> {
                button.text = "ä¸‹è½½"
                progressBar.progress = 0
                button.isEnabled = true  // ç‚¹å‡»å¼€å§‹ä¸‹è½½
            }
        }
    }
}
```

### æŒ‰é’®ç‚¹å‡»å¤„ç†

```kotlin
private fun handleButtonClick(task: DownloadTask?) {
    when (task?.status) {
        DownloadStatus.DOWNLOADING -> {
            DownloadManager.pause(task.id)
        }
        DownloadStatus.PAUSED -> {
            if (DownloadManager.isNetworkAvailable()) {
                DownloadManager.resume(task.id)
            } else {
                showToast("ç½‘ç»œä¸å¯ç”¨")
            }
        }
        DownloadStatus.WAITING, DownloadStatus.PENDING -> {
            DownloadManager.pause(task.id)  // ä»é˜Ÿåˆ—ç§»é™¤
        }
        DownloadStatus.COMPLETED -> {
            installApk(task)
        }
        DownloadStatus.FAILED -> {
            DownloadManager.resume(task.id)  // é‡è¯•
        }
        null -> {
            startNewDownload()
        }
    }
}
```

### ä¸‹è½½é€Ÿåº¦æ ¼å¼åŒ–

```kotlin
fun formatSpeed(bytesPerSecond: Long): String {
    return when {
        bytesPerSecond >= 1024 * 1024 ->
            String.format("%.1f MB/s", bytesPerSecond / (1024.0 * 1024.0))
        bytesPerSecond >= 1024 ->
            String.format("%.0f KB/s", bytesPerSecond / 1024.0)
        else ->
            "$bytesPerSecond B/s"
    }
}

fun formatFileSize(bytes: Long): String {
    return when {
        bytes >= 1024 * 1024 * 1024 ->
            String.format("%.2f GB", bytes / (1024.0 * 1024.0 * 1024.0))
        bytes >= 1024 * 1024 ->
            String.format("%.2f MB", bytes / (1024.0 * 1024.0))
        bytes >= 1024 ->
            String.format("%.2f KB", bytes / 1024.0)
        else ->
            "$bytes B"
    }
}
```

### ç½‘ç»œçŠ¶æ€å˜åŒ–å¤„ç†

```kotlin
// ä½¿ç”¨å¹¿æ’­æ¥æ”¶å™¨ç›‘å¬ç½‘ç»œå˜åŒ–
NetStateReceiver(
    onNetConnected = { isWifi ->
        if (isWifi) {
            // WiFi è¿æ¥ï¼šé‡ç½®æµé‡ä¼šè¯ï¼Œæ¢å¤ WiFi æš‚åœçš„ä»»åŠ¡
            DownloadManager.onWifiConnected()
        }
        // ç½‘ç»œæ¢å¤ï¼šæ¢å¤ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡
        DownloadManager.onNetworkRestored()
    },
    onNetDisConnected = {
        // ç½‘ç»œæ–­å¼€ï¼šæ¡†æ¶ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨æš‚åœä»»åŠ¡
        DownloadManager.onWifiDisconnected()
    }
).register(this)
```

### ä¹è§‚æ›´æ–°ï¼ˆå³æ—¶ UI åé¦ˆï¼‰

ç‚¹å‡»æŒ‰é’®åç«‹å³æ›´æ–° UIï¼Œä¸ç­‰å¾…å›è°ƒï¼š

```kotlin
// ç‚¹å‡»æ¢å¤æŒ‰é’®
fun onResumeClick(task: DownloadTask) {
    // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºé—²ä¸‹è½½æ§½ä½
    val targetStatus = if (DownloadManager.hasAvailableSlot()) {
        DownloadStatus.DOWNLOADING  // ç«‹å³å¼€å§‹
    } else {
        DownloadStatus.WAITING      // è¿›å…¥é˜Ÿåˆ—
    }

    // ä¹è§‚æ›´æ–° UI
    val optimisticTask = task.copy(status = targetStatus)
    adapter.updateItem(optimisticTask)

    // å®é™…æ‰§è¡Œæ¢å¤
    DownloadManager.resume(task.id)
}
```

## ï¿½ğŸ“š é«˜çº§åŠŸèƒ½

### ç½‘ç»œç­–ç•¥é…ç½®

```kotlin
// è®¾ç½®ç½‘ç»œä¸‹è½½é…ç½®
DownloadManager.setNetworkConfig(
    NetworkDownloadConfig(
        wifiOnly = false,                           // æ˜¯å¦ä»… WiFi ä¸‹è½½
        cellularPromptMode = CellularPromptMode.ALWAYS,  // æµé‡æé†’æ¨¡å¼
        checkBeforeCreate = false,                   // åˆ›å»ºå‰æ£€æŸ¥
        checkAfterCreate = true                     // åˆ›å»ºåæ£€æŸ¥
    )
)

// æµé‡æé†’å›è°ƒ
DownloadManager.setCheckAfterCallback(object : CheckAfterCallback {
    override fun onCellularConfirmRequired(tasks: List<DownloadTask>, onConfirm: () -> Unit) {
        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
    }
    override fun onWifiOnlyBlocked(task: DownloadTask) {
        // æ˜¾ç¤ºæç¤º
    }
})
```

**æµé‡æé†’æ¨¡å¼è¯´æ˜ï¼š**

| æ¨¡å¼ | è¯´æ˜ |
|-----|------|
| `ALWAYS` | æ¯æ¬¡ä½¿ç”¨æµé‡æ—¶å¼¹çª—è¯¢é—® |
| `NEVER` | ä¸å†æé†’ï¼Œç›´æ¥ä½¿ç”¨æµé‡ä¸‹è½½ |
| `USER_CONTROLLED` | ç”±ä½¿ç”¨ç«¯è‡ªè¡Œæ§åˆ¶ |

### å­˜å‚¨ä¸ç¼“å­˜ç®¡ç†

```kotlin
// å­˜å‚¨ç®¡ç†
val storageInfo = DownloadManager.getStorageInfo()
val isLowStorage = DownloadManager.isLowStorage()
val recommendedPath = DownloadManager.getRecommendedPath()

// ç¼“å­˜ç®¡ç†
val cacheStats = DownloadManager.getCacheStats()
val hotTasks = DownloadManager.getHotTasks()   // æœ€è¿‘è®¿é—®
val coldTasks = DownloadManager.getColdTasks() // è¾ƒå°‘è®¿é—®

// æ¸…ç†å·²å®Œæˆä»»åŠ¡
DownloadManager.cleanCompleted(
    deleteFiles = false,
    beforeTime = System.currentTimeMillis() - 7 * 24 * 60 * 60 * 1000,
    limit = 50
)
```

### ä¿ç•™ç­–ç•¥

```kotlin
DownloadManager.config {
    retention = Retention(
        keepDays = 30,           // ä¿ç•™ 30 å¤©
        keepLatestCompleted = 100 // æœ€å¤šä¿ç•™ 100 ä¸ªå·²å®Œæˆä»»åŠ¡
    )
}

// æ‰§è¡Œæ¸…ç†ç­–ç•¥
DownloadManager.executeRetentionPolicy()
```

### æ‰¹é‡æ“ä½œ

```kotlin
// æ‰¹é‡åˆ›å»ºä»»åŠ¡
val builders = urls.map { url ->
    DownloadManager.download(url).path(path).fileName(getFileName(url))
}
DownloadManager.startTasks(builders)

// æ‰¹é‡æ“ä½œ
DownloadManager.pauseAll()
DownloadManager.resumeAll()
DownloadManager.cancelAll()
```

### ç½‘ç»œçŠ¶æ€ç›‘æ§

```kotlin
// æ£€æŸ¥ç½‘ç»œçŠ¶æ€
val isAvailable = DownloadManager.isNetworkAvailable()
val isWifi = DownloadManager.isWifiAvailable()
val isCellular = DownloadManager.isCellularAvailable()
val networkType = DownloadManager.getNetworkType()  // WIFI, CELLULAR_4G, CELLULAR_5G ç­‰
val isMetered = DownloadManager.isMeteredNetwork()

// ç½‘ç»œæ¢å¤æ—¶è‡ªåŠ¨æ¢å¤ä¸‹è½½
DownloadManager.onNetworkRestored()
```

## ğŸ“‹ æ•°æ®æ¨¡å‹

### DownloadTask

```kotlin
data class DownloadTask(
    val id: String,
    val url: String,
    val fileName: String,
    val filePath: String,
    val status: DownloadStatus,
    val progress: Int,
    val totalSize: Long,
    val currentSize: Long,
    val speed: Long,
    val priority: Int,
    val createTime: Long,
    val updateTime: Long,
    val packageName: String? = null,
    val pauseReason: PauseReason? = null,
    val estimatedSize: Long = 0L,
    val cellularConfirmed: Boolean = false
)
```

### DownloadStatus

| çŠ¶æ€ | è¯´æ˜ |
|-----|------|
| `WAITING` | ç­‰å¾…ä¸­ |
| `PENDING` | å‡†å¤‡ä¸­ |
| `DOWNLOADING` | ä¸‹è½½ä¸­ |
| `PAUSED` | å·²æš‚åœ |
| `COMPLETED` | å·²å®Œæˆ |
| `FAILED` | å¤±è´¥ |
| `CANCELLED` | å·²å–æ¶ˆ |

### DownloadPriority

| ä¼˜å…ˆçº§ | å€¼ | è¯´æ˜ |
|-------|---|------|
| `LOW` | 0 | åå°ä¸‹è½½ |
| `NORMAL` | 1 | æ™®é€šä¸‹è½½ï¼ˆé»˜è®¤ï¼‰ |
| `HIGH` | 2 | ç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ |
| `URGENT` | 3 | ç³»ç»Ÿå…³é”®ä¸‹è½½ |

## ğŸ—ï¸ é¡¹ç›®ç»“æ„

```
download-manager/
â”œâ”€â”€ app/                          # ç¤ºä¾‹åº”ç”¨
â”‚   â””â”€â”€ src/main/java/.../demo/
â”‚       â”œâ”€â”€ MainActivity.kt             # ä¸»ç•Œé¢
â”‚       â”œâ”€â”€ DownloadManagerActivity.kt  # ä¸‹è½½ç®¡ç†ç•Œé¢
â”‚       â”œâ”€â”€ AppDetailActivity.kt        # åº”ç”¨è¯¦æƒ…
â”‚       â”œâ”€â”€ floatwindow/                # æ‚¬æµ®çª—ç»„ä»¶
â”‚       â”œâ”€â”€ widget/                     # è‡ªå®šä¹‰æ§ä»¶
â”‚       â””â”€â”€ ...
â”œâ”€â”€ downloader/                   # æ ¸å¿ƒä¸‹è½½åº“
â”‚   â””â”€â”€ src/main/java/.../download/
â”‚       â”œâ”€â”€ core/                       # æ ¸å¿ƒæ¨¡å—
â”‚       â”‚   â”œâ”€â”€ DownloadManager.kt           # ä¸‹è½½ç®¡ç†å™¨
â”‚       â”‚   â”œâ”€â”€ MultiThreadDownloadEngine.kt # å¤šçº¿ç¨‹ä¸‹è½½å¼•æ“
â”‚       â”‚   â”œâ”€â”€ FlowDownloadListener.kt      # Flow ç›‘å¬å™¨
â”‚       â”‚   â”œâ”€â”€ AdvancedDownloadQueueDispatcher.kt # é˜Ÿåˆ—è°ƒåº¦å™¨
â”‚       â”‚   â”œâ”€â”€ NetworkRuleManager.kt        # ç½‘ç»œè§„åˆ™ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ StorageManager.kt            # å­˜å‚¨ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ CacheManager.kt              # ç¼“å­˜ç®¡ç†
â”‚       â”‚   â”œâ”€â”€ RetentionManager.kt          # ä¿ç•™ç­–ç•¥
â”‚       â”‚   â””â”€â”€ ...
â”‚       â”œâ”€â”€ model/                      # æ•°æ®æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ DownloadTask.kt              # ä»»åŠ¡æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ DownloadStatus.kt            # çŠ¶æ€æšä¸¾
â”‚       â”‚   â”œâ”€â”€ DownloadChunk.kt             # åˆ†ç‰‡æ¨¡å‹
â”‚       â”‚   â”œâ”€â”€ NetworkDownloadConfig.kt     # ç½‘ç»œé…ç½®
â”‚       â”‚   â””â”€â”€ PauseReason.kt               # æš‚åœåŸå› 
â”‚       â”œâ”€â”€ store/                      # æ•°æ®å­˜å‚¨
â”‚       â”‚   â”œâ”€â”€ db/                          # Room æ•°æ®åº“
â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadDatabase.kt
â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadEntity.kt
â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadChunkEntity.kt
â”‚       â”‚   â”‚   â””â”€â”€ ...
â”‚       â”‚   â””â”€â”€ TaskRepository.kt            # ä»»åŠ¡ä»“åº“
â”‚       â”œâ”€â”€ config/                     # é…ç½®
â”‚       â”‚   â””â”€â”€ DownloadConfig.kt
â”‚       â””â”€â”€ utils/                      # å·¥å…·ç±»
â”‚           â”œâ”€â”€ OkHttpHelper.kt
â”‚           â”œâ”€â”€ FileUtils.kt
â”‚           â”œâ”€â”€ NetworkUtils.kt
â”‚           â””â”€â”€ ...
â””â”€â”€ build.gradle.kts
```

## ğŸ”‘ æƒé™

åœ¨ `AndroidManifest.xml` ä¸­æ·»åŠ ï¼š

```xml
<!-- ç½‘ç»œæƒé™ -->
<uses-permission android:name="android.permission.INTERNET" />
<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- å­˜å‚¨æƒé™ -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" />
<uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />

    <!-- Android 11+ å­˜å‚¨æƒé™ï¼ˆæŒ‰éœ€ï¼‰-->
<uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />
```

## ğŸ”§ é…ç½®å‚æ•°

```kotlin
data class DownloadConfig(
    var maxConcurrentTasks: Int = 1,        // æœ€å¤§å¹¶å‘ä»»åŠ¡æ•°
    var maxConcurrentOnWifi: Int = 1,       // WiFi ä¸‹æœ€å¤§å¹¶å‘
    var maxConcurrentOnCellular: Int = 1,   // ç§»åŠ¨ç½‘ç»œä¸‹æœ€å¤§å¹¶å‘
    var maxConcurrentOnLowBattery: Int = 1, // ä½ç”µé‡ä¸‹æœ€å¤§å¹¶å‘
    var connectTimeoutSec: Long = 60,       // è¿æ¥è¶…æ—¶ï¼ˆç§’ï¼‰
    var readTimeoutSec: Long = 60,          // è¯»å–è¶…æ—¶ï¼ˆç§’ï¼‰
    var writeTimeoutSec: Long = 60,         // å†™å…¥è¶…æ—¶ï¼ˆç§’ï¼‰
    var allowMetered: Boolean = true,       // å…è®¸è®¡è´¹ç½‘ç»œ
    var callbackOnMain: Boolean = true,     // å›è°ƒåœ¨ä¸»çº¿ç¨‹
    var checksum: Checksum? = null,         // æ ¡éªŒé…ç½®
    var retention: Retention = Retention()  // ä¿ç•™ç­–ç•¥
)
```

## ğŸ¯ åˆ†ç‰‡ç­–ç•¥

æ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çº¿ç¨‹æ•°ï¼š

| æ–‡ä»¶å¤§å° | çº¿ç¨‹æ•° |
|---------|-------|
| < 1MB | 1 |
| 1MB ~ 10MB | 2 |
| 10MB ~ 100MB | 3 |
| > 100MB | 4 |

## ğŸ“ æ··æ·†è§„åˆ™

```proguard
-keep class com.pichs.download.** { *; }
-keepclassmembers class com.pichs.download.** { *; }
```

## ğŸ“„ å¼€æºè®¸å¯

æœ¬é¡¹ç›®é‡‡ç”¨ [Apache License 2.0](LICENSE) å¼€æºè®¸å¯åè®®ã€‚

## ğŸ¤ è´¡çŒ®

æ¬¢è¿æäº¤ Issue å’Œ Pull Requestï¼
