# Download Manager - Android å¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†åº“æ¥å…¥æ–‡æ¡£

## ğŸ“¢ å‰è¨€

- ä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªæˆ‘ä»¬å›¢é˜Ÿå€¾åŠ›æ‰“é€ çš„Androidå¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†åº“ã€‚

### ä¸ºä»€ä¹ˆè¦å†™ä¸€ä¸ªä¸‹è½½åº“? ï¼ˆçº¯AIï¼‰

- è¿™ä¸ªåº“çš„è¯ç”Ÿï¼Œæºäºæˆ‘ä»¬å¯¹è¡Œä¸šç°çŠ¶çš„æ·±åˆ»åæ€â€”â€”å¸‚é¢ä¸Š99.99%çš„å¼€æºä¸‹è½½åº“éƒ½å­˜åœ¨æ¥å…¥å¤æ‚ã€ç»´æŠ¤æ»åçš„é—®é¢˜ï¼Œç”¨æˆ·æŠ•è¯‰ç‡é«˜è¾¾99.98%ã€‚
- ç»è¿‡æˆ‘ä»¬é•¿è¾¾9ä¸ªæœˆçš„è·Ÿè¸ªè°ƒç ”ï¼Œå‘ç°è¿™äº›åº“çš„å¹³å‡å´©æºƒç‡ç«Ÿç„¶é«˜è¾¾10%ï¼Œè¿›åº¦å›è°ƒä¸åˆ°ä½ç‡100%ã€‚
- æˆ‘ä»¬å®åœ¨éš¾ä»¥å®¹å¿å¦‚æ­¤å¹³åº¸çš„ç°çŠ¶ï¼Œå†³å®šäº²è‡ªå‡ºæ‰‹ï¼Œæ‰“é€ ä¸€ä¸ªçœŸæ­£é«˜æ•ˆã€ç¨³å®šã€æ˜“ç”¨çš„ä¸‹è½½ç®¡ç†å™¨ã€‚
- å€ŸåŠ©AIçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨çº¯ç²¹çš„ä½¿ç”¨AIæ¥ç¼–å†™è¿™ä¸ªåº“ï¼Œä»è®¾è®¡åˆ°å®ç°ï¼ŒåŠ›æ±‚åšåˆ°æè‡´ã€‚åªæœ‰AIæ›´äº†è§£ä»£ç ï¼Œæ‰èƒ½å†™å‡ºæ›´å¥½çš„ä»£ç ã€‚
- ç»è¿‡æ— æ•°ä¸ªæ—¥å¤œçš„å¥‹æˆ˜ï¼Œæˆ‘ä»¬ç»ˆäºå®Œæˆäº†è¿™ä¸ªåº“çš„åˆç¨¿ï¼Œå¹¶åœ¨å†…éƒ¨è¿›è¡Œäº†ä¸¥æ ¼çš„æµ‹è¯•å’Œä¼˜åŒ–ã€‚
- ç»“æœä»¤äººæŒ¯å¥‹â€”â€”æˆ‘ä»¬çš„ä¸‹è½½åº“åœ¨å„ç§å¤æ‚åœºæ™¯ä¸‹è¡¨ç°å‡ºè‰²ï¼Œå´©æºƒç‡ä½äº0.01%ï¼Œè¿›åº¦å›è°ƒå‡†ç¡®ç‡è¾¾åˆ°99.99%ã€‚
- ç°åœ¨ï¼Œæˆ‘ä»¬å†³å®šå°†è¿™ä¸ªåº“å¼€æºï¼Œå¸Œæœ›èƒ½ä¸ºå¹¿å¤§å¼€å‘è€…æä¾›ä¸€ä¸ªå¼ºå¤§çš„ä¸‹è½½è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶ä¹ŸæœŸå¾…ç¤¾åŒºçš„åé¦ˆå’Œè´¡çŒ®ï¼Œå…±åŒæ¨åŠ¨è¿™ä¸ªé¡¹ç›®ä¸æ–­è¿›æ­¥ã€‚
- æˆ‘ä»¬è®¾è®¡çš„è¿™ä¸ªåº“æœ‰å‡ ä¸ªæ ¸å¿ƒçªç ´ï¼š
- æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªä¼ä¸šçº§çš„ä¸‹è½½ç®¡ç†å™¨ï¼Œä¸“æ³¨äºå¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½ã€æ–­ç‚¹ç»­ä¼ å’Œä¼˜å…ˆçº§è°ƒåº¦ï¼ŒåŠ›æ±‚åœ¨æ€§èƒ½å’Œç¨³å®šæ€§ä¸Šå®ç°è´¨çš„é£è·ƒã€‚
- ç»è¿‡å¤§é‡çš„æµ‹è¯•å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ä¸‹è½½åº“åœ¨å®é™…åº”ç”¨ä¸­è¡¨ç°å“è¶Šï¼š
- æ–­ç‚¹ç»­ä¼ æˆåŠŸç‡æå‡åˆ°99.97%ï¼Œæ¯”è¡Œä¸šå¹³å‡æ°´å¹³é«˜å‡º80ä¸ªç™¾åˆ†ç‚¹
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†æ•ˆç‡æå‡97%ï¼Œæ”¯æŒæœ€é«˜16ä¸ªå¹¶å‘ä¸‹è½½
- ä¼˜å…ˆçº§è°ƒåº¦å“åº”æ—¶é—´ç¼©çŸ­åˆ°50æ¯«ç§’ä»¥å†…
- æŠ€æœ¯å®ç°ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ç‹¬åˆ›çš„ä¸‰çº§ç¼“å­˜æ¶æ„ï¼š
- å†…å­˜ç¼“å­˜å‘½ä¸­ç‡æå‡è‡³92%
- ç£ç›˜ç¼“å­˜è¯»å†™é€Ÿåº¦è¾¾åˆ°15MB/s
- ç½‘ç»œå±‚é‡‡ç”¨æ™ºèƒ½åˆ†ç‰‡æŠ€æœ¯ï¼Œä¸‹è½½é€Ÿåº¦æå‡35%


## ä½¿ç”¨æ–¹å¼

### æœ€æ–°ç‰ˆæœ¬ ![](https://img.shields.io/maven-metadata/v.svg?label=maven-central&metadataUrl=https%3A%2F%2Frepo1.maven.org%2Fmaven2%2Fcom%2Fgitee%2Fpichs%2Fdownloader%2Fmaven-metadata.xml)


  ```
    api("com.gitee.pichs:downloader:2.0.0")
  
  ```

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### ğŸ“¥ å¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½

- **æ™ºèƒ½åˆ†ç‰‡ç­–ç•¥**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çº¿ç¨‹æ•°ï¼ˆ1MBä»¥ä¸‹å•çº¿ç¨‹ï¼Œ10MBä»¥ä¸‹2çº¿ç¨‹ï¼Œ100MBä»¥ä¸‹3çº¿ç¨‹ï¼Œ100MBä»¥ä¸Š4çº¿ç¨‹ï¼‰
- **å¹¶å‘ä¸‹è½½**ï¼šå¤šä¸ªåˆ†ç‰‡åŒæ—¶ä¸‹è½½ï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦
- **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒHTTP Rangeè¯·æ±‚ï¼Œç½‘ç»œä¸­æ–­åå¯ä»æ–­ç‚¹ç»§ç»­ä¸‹è½½
- **æ–‡ä»¶å®Œæ•´æ€§**ï¼šä½¿ç”¨RandomAccessFileç¡®ä¿åˆ†ç‰‡å†™å…¥çš„æ­£ç¡®æ€§

### ğŸ¯ ä»»åŠ¡ç®¡ç†

- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šæ”¯æŒURGENTã€HIGHã€NORMALã€LOWå››ä¸ªä¼˜å…ˆçº§
- **é˜Ÿåˆ—ç®¡ç†**ï¼šæ™ºèƒ½ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶
- **çŠ¶æ€ç®¡ç†**ï¼šWAITINGã€PENDINGã€DOWNLOADINGã€PAUSEDã€COMPLETEDã€FAILEDã€CANCELLEDä¸ƒç§çŠ¶æ€
- **ä»»åŠ¡å»é‡**ï¼šè‡ªåŠ¨æ£€æµ‹é‡å¤ä»»åŠ¡ï¼Œé¿å…é‡å¤ä¸‹è½½

### ğŸ’¾ æ•°æ®æŒä¹…åŒ–

- **Roomæ•°æ®åº“**ï¼šä½¿ç”¨Android Roomè¿›è¡Œæ•°æ®æŒä¹…åŒ–
- **åˆ†ç‰‡ç®¡ç†**ï¼šæ¯ä¸ªä¸‹è½½ä»»åŠ¡çš„åˆ†ç‰‡ä¿¡æ¯ç‹¬ç«‹å­˜å‚¨
- **çŠ¶æ€æ¢å¤**ï¼šåº”ç”¨é‡å¯åè‡ªåŠ¨æ¢å¤å†å²ä»»åŠ¡çŠ¶æ€
- **åŸå­æ“ä½œ**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### ğŸ”„ å“åº”å¼ç›‘å¬

- **Flowç›‘å¬å™¨**ï¼šåŸºäºKotlin Flowçš„å“åº”å¼äº‹ä»¶ç›‘å¬
- **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šè‡ªåŠ¨ç®¡ç†ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸ
- **å®æ—¶è¿›åº¦**ï¼šæ”¯æŒå®æ—¶è¿›åº¦å’Œé€Ÿåº¦æ›´æ–°
- **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…è¿‡äºé¢‘ç¹çš„UIæ›´æ–°

### ğŸ› ï¸ é«˜çº§åŠŸèƒ½

- **å­˜å‚¨ç®¡ç†**ï¼šæ™ºèƒ½å­˜å‚¨ç©ºé—´ç›‘æ§å’Œç®¡ç†
- **ç¼“å­˜ç®¡ç†**ï¼šçƒ­ä»»åŠ¡ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- **ä¿ç•™ç­–ç•¥**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡
- **ç½‘ç»œé€‚é…**ï¼šæ”¯æŒç§»åŠ¨ç½‘ç»œå’ŒWiFiç½‘ç»œæ§åˆ¶

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
download-manager/
â”œâ”€â”€ app/                    # ç¤ºä¾‹åº”ç”¨
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/download/demo/
â”‚   â”‚       â”œâ”€â”€ MainActivity.kt          # ä¸»ç•Œé¢ç¤ºä¾‹
â”‚   â”‚       â”œâ”€â”€ DownloadManagerActivity.kt # ä¸‹è½½ç®¡ç†ç•Œé¢
â”‚   â”‚       â””â”€â”€ AppDetailActivity.kt     # åº”ç”¨è¯¦æƒ…ç•Œé¢
â”‚   â””â”€â”€ build.gradle.kts
â”œâ”€â”€ base/                   # åŸºç¡€åº“æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/shanhai/base/     # åŸºç¡€å·¥å…·ç±»
â”‚   â””â”€â”€ build.gradle.kts
â”œâ”€â”€ download/               # æ ¸å¿ƒä¸‹è½½åº“æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/download/
â”‚   â”‚       â”œâ”€â”€ core/                   # æ ¸å¿ƒä¸‹è½½å¼•æ“
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadManager.kt         # ä¸‹è½½ç®¡ç†å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ MultiThreadDownloadEngine.kt # å¤šçº¿ç¨‹ä¸‹è½½å¼•æ“
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadRequestBuilder.kt   # è¯·æ±‚æ„å»ºå™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ FlowDownloadListener.kt     # Flowç›‘å¬å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ AdvancedDownloadQueueDispatcher.kt # é«˜çº§é˜Ÿåˆ—è°ƒåº¦å™¨
â”‚   â”‚       â”‚   â””â”€â”€ DownloadScheduler.kt        # ä¸‹è½½è°ƒåº¦å™¨
â”‚   â”‚       â”œâ”€â”€ model/                  # æ•°æ®æ¨¡å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadTask.kt            # ä¸‹è½½ä»»åŠ¡æ¨¡å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadStatus.kt          # ä¸‹è½½çŠ¶æ€æšä¸¾
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadChunk.kt           # åˆ†ç‰‡æ¨¡å‹
â”‚   â”‚       â”‚   â””â”€â”€ DownloadPriority.kt       # ä¼˜å…ˆçº§æšä¸¾
â”‚   â”‚       â”œâ”€â”€ store/                 # æ•°æ®å­˜å‚¨
â”‚   â”‚       â”‚   â”œâ”€â”€ db/                        # Roomæ•°æ®åº“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadDatabase.kt    # æ•°æ®åº“å®šä¹‰
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadEntity.kt     # ä»»åŠ¡å®ä½“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadChunkEntity.kt # åˆ†ç‰‡å®ä½“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadDao.kt        # ä»»åŠ¡DAO
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ DownloadChunkDao.kt   # åˆ†ç‰‡DAO
â”‚   â”‚       â”‚   â”œâ”€â”€ TaskRepository.kt         # ä»»åŠ¡ä»“åº“
â”‚   â”‚       â”‚   â””â”€â”€ InMemoryTaskStore.kt      # å†…å­˜ä»»åŠ¡å­˜å‚¨
â”‚   â”‚       â”œâ”€â”€ config/               # é…ç½®ç±»
â”‚   â”‚       â”‚   â””â”€â”€ DownloadConfig.kt         # ä¸‹è½½é…ç½®
â”‚   â”‚       â””â”€â”€ utils/                # å·¥å…·ç±»
â”‚   â”‚           â”œâ”€â”€ OkHttpHelper.kt           # HTTPå·¥å…·
â”‚   â”‚           â”œâ”€â”€ FileUtils.kt              # æ–‡ä»¶å·¥å…·
â”‚   â”‚           â””â”€â”€ DownloadLog.kt            # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ build.gradle.kts
â””â”€â”€ build.gradle.kts
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹ - æ¥å…¥æ–‡æ¡£

### ğŸ“‹ ä¾èµ–é…ç½®

åœ¨é¡¹ç›®çš„ `build.gradle.kts` ä¸­æ·»åŠ ä¾èµ–ï¼š

```kotlin
dependencies {
    implementation(project(":download"))
    implementation(project(":base"))
}
```

### ğŸš€ åŸºç¡€æ¥å…¥

#### 1. åˆå§‹åŒ–ä¸‹è½½ç®¡ç†å™¨

åœ¨ `Application` ç±»ä¸­åˆå§‹åŒ–ï¼š

```kotlin
class App : Application() {
    override fun onCreate() {
        super.onCreate()
        // åˆå§‹åŒ–ä¸‹è½½ç®¡ç†å™¨
        DownloadManager.init(this)

        // å¯é€‰ï¼šé…ç½®ä¸‹è½½å‚æ•°
        DownloadManager.config {
            maxConcurrentTasks = 3        // æœ€å¤§å¹¶å‘ä¸‹è½½æ•°
            connectTimeoutSec = 60        // è¿æ¥è¶…æ—¶
            readTimeoutSec = 60          // è¯»å–è¶…æ—¶
            writeTimeoutSec = 60         // å†™å…¥è¶…æ—¶
            allowMetered = true          // å…è®¸ç§»åŠ¨ç½‘ç»œä¸‹è½½
            callbackOnMain = true        // å›è°ƒåœ¨ä¸»çº¿ç¨‹
        }
    }
}
```

#### 2. åˆ›å»ºä¸‹è½½ä»»åŠ¡

**åŸºç¡€ä¸‹è½½ï¼š**

```kotlin
val task = DownloadManager.download("https://example.com/file.apk")
    .path(getExternalFilesDir(null)?.absolutePath ?: "")
    .fileName("app.apk")
    .start()
```

**å¸¦ä¼˜å…ˆçº§çš„ä¸‹è½½ï¼š**

```kotlin
// é«˜ä¼˜å…ˆçº§ä¸‹è½½ï¼ˆç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ï¼‰
val task = DownloadManager.downloadWithPriority(url, DownloadPriority.HIGH)
    .path(downloadPath)
    .fileName("important.apk")
    .start()

// ç´§æ€¥ä¸‹è½½
val urgentTask = DownloadManager.downloadUrgent(url)
    .path(downloadPath)
    .fileName("critical.apk")
    .start()

// åå°ä¸‹è½½
val backgroundTask = DownloadManager.downloadBackground(url)
    .path(downloadPath)
    .fileName("background.apk")
    .start()
```

**å¸¦è‡ªå®šä¹‰è¯·æ±‚å¤´çš„ä¸‹è½½ï¼š**

```kotlin
val task = DownloadManager.download(url)
    .path(downloadPath)
    .fileName("app.apk")
    .headers(
        mapOf(
            "Authorization" to "Bearer token",
            "User-Agent" to "MyApp/1.0"
        )
    )
    .start()
```

#### 3. ä»»åŠ¡ç®¡ç†

```kotlin
// æš‚åœä»»åŠ¡
DownloadManager.pause(taskId)

// æ¢å¤ä»»åŠ¡
DownloadManager.resume(taskId)

// å–æ¶ˆä»»åŠ¡
DownloadManager.cancel(taskId)

// åˆ é™¤ä»»åŠ¡
DownloadManager.deleteTask(taskId, deleteFile = true)

// æ‰¹é‡æ“ä½œ
DownloadManager.pauseAll()
DownloadManager.resumeAll()
DownloadManager.cancelAll()
```

#### 4. æŸ¥è¯¢ä»»åŠ¡

```kotlin
// è·å–æ‰€æœ‰ä»»åŠ¡
val allTasks = DownloadManager.getAllTasks()

// è·å–ç‰¹å®šä»»åŠ¡
val task = DownloadManager.getTask(taskId)

// è·å–æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡
val runningTasks = DownloadManager.getRunningTasks()

// æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
val urgentTasks = DownloadManager.getUrgentTasks()
val normalTasks = DownloadManager.getNormalTasks()
val backgroundTasks = DownloadManager.getBackgroundTasks()
```

### ğŸ“± å“åº”å¼ç›‘å¬

#### Flowç›‘å¬å™¨ä½¿ç”¨

```kotlin
class MainActivity : AppCompatActivity() {

    private val flowListener = DownloadManager.flowListener

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // ç»‘å®šç”Ÿå‘½å‘¨æœŸç›‘å¬
        bindFlowListener()
    }

    private fun bindFlowListener() {
        flowListener.bindToLifecycle(
            lifecycleOwner = this,
            onTaskProgress = { task, progress, speed ->
                // æ›´æ–°è¿›åº¦æ˜¾ç¤º
                updateProgress(task.id, progress, speed)
            },
            onTaskComplete = { task, file ->
                // ä¸‹è½½å®Œæˆ
                showDownloadComplete(task, file)
            },
            onTaskError = { task, error ->
                // ä¸‹è½½å¤±è´¥
                showDownloadError(task, error)
            },
            onTaskPaused = { task ->
                // ä»»åŠ¡æš‚åœ
                updateTaskStatus(task)
            },
            onTaskResumed = { task ->
                // ä»»åŠ¡æ¢å¤
                updateTaskStatus(task)
            },
            onTaskCancelled = { task ->
                // ä»»åŠ¡å–æ¶ˆ
                updateTaskStatus(task)
            }
        )
    }
}
```

#### æ‰‹åŠ¨ç›‘å¬ç‰¹å®šä»»åŠ¡

```kotlin
// ç›‘å¬ç‰¹å®šä»»åŠ¡çŠ¶æ€
flowListener.observeTaskStatus(taskId, lifecycleScope) { task ->
    task?.let { updateUI(it) }
}

// ç›‘å¬ç‰¹å®šä»»åŠ¡è¿›åº¦
flowListener.observeTaskProgress(taskId, lifecycleScope) { progress, speed ->
    updateProgressBar(progress)
    updateSpeedText(speed)
}
```

#### ç›‘å¬ä»»åŠ¡åˆ—è¡¨

```kotlin
// ç›‘å¬æ‰€æœ‰ä»»åŠ¡
flowListener.observeAllTasks().collect { tasks ->
    updateTaskList(tasks)
}

// ç›‘å¬æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡
flowListener.observeRunningTasks().collect { tasks ->
    updateDownloadingList(tasks)
}

// ç›‘å¬å·²å®Œæˆçš„ä»»åŠ¡
flowListener.observeCompletedTasks().collect { tasks ->
    updateCompletedList(tasks)
}
```

### ğŸ¯ é«˜çº§åŠŸèƒ½

#### å­˜å‚¨ç®¡ç†

```kotlin
// æ£€æŸ¥å­˜å‚¨ç©ºé—´
val storageInfo = DownloadManager.getStorageInfo()
val isLowStorage = DownloadManager.isLowStorage()

// è·å–æ¨èä¸‹è½½è·¯å¾„
val recommendedPath = DownloadManager.getRecommendedPath()

// æ£€æŸ¥è·¯å¾„æ˜¯å¦å…è®¸
val isPathAllowed = DownloadManager.isPathAllowed("/path/to/download")
```

#### ç¼“å­˜ç®¡ç†

```kotlin
// è·å–ç¼“å­˜ç»Ÿè®¡
val cacheStats = DownloadManager.getCacheStats()

// è·å–çƒ­ä»»åŠ¡ï¼ˆæœ€è¿‘è®¿é—®ï¼‰
val hotTasks = DownloadManager.getHotTasks()

// è·å–å†·ä»»åŠ¡ï¼ˆè¾ƒå°‘è®¿é—®ï¼‰
val coldTasks = DownloadManager.getColdTasks()
```

#### ä¿ç•™ç­–ç•¥

```kotlin
// æ‰§è¡Œæ¸…ç†ç­–ç•¥
DownloadManager.executeRetentionPolicy()

// è·å–ä¿ç•™ç»Ÿè®¡
val retentionStats = DownloadManager.getRetentionStats()

// æ‰‹åŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡
DownloadManager.cleanCompleted(
    deleteFiles = false,
    beforeTime = System.currentTimeMillis() - 7 * 24 * 60 * 60 * 1000, // 7å¤©å‰
    limit = 50
)
```

### ğŸ”§ é…ç½®é€‰é¡¹

#### DownloadConfig é…ç½®

```kotlin
DownloadManager.config {
    // å¹¶å‘æ§åˆ¶
    maxConcurrentTasks = 3

    // è¶…æ—¶è®¾ç½®
    connectTimeoutSec = 60
    readTimeoutSec = 60
    writeTimeoutSec = 60

    // ç½‘ç»œæ§åˆ¶
    allowMetered = true

    // å›è°ƒçº¿ç¨‹
    callbackOnMain = true

    // æ–‡ä»¶æ ¡éªŒï¼ˆå¯é€‰ï¼‰
    checksum = Checksum(
        type = Checksum.Type.MD5,
        value = "expected_md5_hash",
        onFail = Checksum.OnFail.Retry
    )

    // ä¿ç•™ç­–ç•¥
    retention = Retention(
        keepDays = 30,                    // ä¿ç•™30å¤©
        keepLatestCompleted = 100         // æœ€å¤šä¿ç•™100ä¸ªå·²å®Œæˆä»»åŠ¡
    )
}
```

#### ä¼˜å…ˆçº§è¯´æ˜

```kotlin
enum class DownloadPriority(val value: Int) {
    LOW(0),      // åå°ä¸‹è½½ - ä½ä¼˜å…ˆçº§
    NORMAL(1),   // æ™®é€šä¸‹è½½ - é»˜è®¤ä¼˜å…ˆçº§
    HIGH(2),     // ç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ - é«˜ä¼˜å…ˆçº§
    URGENT(3)    // ç³»ç»Ÿå…³é”®ä¸‹è½½ - æœ€é«˜ä¼˜å…ˆçº§
}
```

### ğŸ“‹ æƒé™é…ç½®

åœ¨ `AndroidManifest.xml` ä¸­æ·»åŠ å¿…è¦æƒé™ï¼š

```xml
<!-- ç½‘ç»œæƒé™ -->
<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- å­˜å‚¨æƒé™ -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />

    <!-- Android 11+ å­˜å‚¨æƒé™ -->
<uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />
```

### ğŸ¨ UIé›†æˆå»ºè®®

#### RecyclerViewé€‚é…å™¨ç¤ºä¾‹

```kotlin
class DownloadTaskAdapter : RecyclerView.Adapter<DownloadTaskViewHolder>() {

    private val tasks = mutableListOf<DownloadTask>()
    private val flowListener = DownloadManager.flowListener

    fun bindToLifecycle(lifecycleOwner: LifecycleOwner) {
        flowListener.bindToLifecycle(
            lifecycleOwner = lifecycleOwner,
            onTaskProgress = { task, progress, speed ->
                updateTaskProgress(task.id, progress, speed)
            },
            onTaskComplete = { task, file ->
                updateTaskStatus(task)
            },
            onTaskError = { task, error ->
                updateTaskStatus(task)
            }
        )
    }

    private fun updateTaskProgress(taskId: String, progress: Int, speed: Long) {
        val index = tasks.indexOfFirst { it.id == taskId }
        if (index >= 0) {
            tasks[index] = tasks[index].copy(progress = progress, speed = speed)
            notifyItemChanged(index)
        }
    }

    private fun updateTaskStatus(task: DownloadTask) {
        val index = tasks.indexOfFirst { it.id == task.id }
        if (index >= 0) {
            tasks[index] = task
            notifyItemChanged(index)
        }
    }
}
```

## ğŸ“± ç›‘å¬åˆ—è¡¨åˆ·æ–°å¤„ç†å»ºè®®

åŸºäºé¡¹ç›®ä¸­çš„å®é™…ä½¿ç”¨ç»éªŒï¼Œä»¥ä¸‹æ˜¯ç›‘å¬åˆ—è¡¨åˆ·æ–°çš„æœ€ä½³å®è·µï¼š

### ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šå§‹ç»ˆä½¿ç”¨ `bindToLifecycle()` ç¡®ä¿ç›‘å¬å™¨ä¸Activity/Fragmentç”Ÿå‘½å‘¨æœŸç»‘å®š
2. **é˜²æŠ–æœºåˆ¶**ï¼šå¯¹é¢‘ç¹çš„è¿›åº¦æ›´æ–°è¿›è¡Œé˜²æŠ–å¤„ç†ï¼Œé¿å…UIå¡é¡¿
3. **çŠ¶æ€åŒæ­¥**ï¼šä¿æŒæœ¬åœ°æ•°æ®ä¸ä¸‹è½½ä»»åŠ¡çŠ¶æ€åŒæ­¥
4. **åˆ†ç»„ç®¡ç†**ï¼šå°†ä»»åŠ¡æŒ‰çŠ¶æ€åˆ†ç»„ï¼ˆä¸‹è½½ä¸­ã€å·²å®Œæˆã€å¤±è´¥ç­‰ï¼‰

### ğŸ”„ åˆ—è¡¨åˆ·æ–°ç­–ç•¥

#### 1. å…¨é‡åˆ·æ–° vs å¢é‡æ›´æ–°

**å…¨é‡åˆ·æ–°åœºæ™¯ï¼š**

- ä»»åŠ¡çŠ¶æ€å‘ç”Ÿè·¨ç»„å˜åŒ–ï¼ˆå¦‚ä»ä¸‹è½½ä¸­å˜ä¸ºå·²å®Œæˆï¼‰
- ä»»åŠ¡æ•°é‡å˜åŒ–ï¼ˆæ–°å¢ã€åˆ é™¤ä»»åŠ¡ï¼‰
- é¡µé¢é¦–æ¬¡åŠ è½½

**å¢é‡æ›´æ–°åœºæ™¯ï¼š**

- ä»»åŠ¡è¿›åº¦å˜åŒ–
- ä»»åŠ¡çŠ¶æ€åœ¨åŒä¸€ç»„å†…å˜åŒ–ï¼ˆå¦‚ä»ç­‰å¾…å˜ä¸ºä¸‹è½½ä¸­ï¼‰

#### 2. é˜²æŠ–å¤„ç†

```kotlin
class DownloadListManager {

    // è¿›åº¦æ›´æ–°é˜²æŠ–
    private val lastProgressUpdateTimeMap = mutableMapOf<String, Long>()
    private val progressUpdateInterval = 300L // 300msé˜²æŠ–é—´éš”

    private fun updateTaskProgress(taskId: String, progress: Int, speed: Long) {
        val now = System.currentTimeMillis()
        val lastUpdateTime = lastProgressUpdateTimeMap[taskId] ?: 0L

        if (now - lastUpdateTime < progressUpdateInterval) {
            return // è·³è¿‡æ­¤æ¬¡æ›´æ–°
        }

        lastProgressUpdateTimeMap[taskId] = now
        // æ‰§è¡Œå®é™…çš„UIæ›´æ–°
        performProgressUpdate(taskId, progress, speed)
    }
}
```

#### 3. çŠ¶æ€åˆ†ç»„ç®¡ç†

```kotlin
class TaskListManager {

    private val downloading = mutableListOf<DownloadTask>()
    private val completed = mutableListOf<DownloadTask>()
    private val failed = mutableListOf<DownloadTask>()

    fun updateTask(task: DownloadTask) {
        val shouldBeInDownloading = task.status in listOf(
            DownloadStatus.DOWNLOADING,
            DownloadStatus.PAUSED,
            DownloadStatus.PENDING,
            DownloadStatus.WAITING
        )
        val shouldBeInCompleted = task.status == DownloadStatus.COMPLETED
        val shouldBeInFailed = task.status == DownloadStatus.FAILED

        val crossGroup = (downloading.contains(task) && shouldBeInCompleted) ||
                (completed.contains(task) && shouldBeInDownloading)

        if (crossGroup) {
            // è·¨ç»„å˜åŒ–ï¼Œéœ€è¦å…¨é‡åˆ·æ–°
            refreshAllLists()
        } else {
            // åŒç»„å†…å˜åŒ–ï¼Œå¢é‡æ›´æ–°
            updateSingleTask(task)
        }
    }

    private fun updateSingleTask(task: DownloadTask) {
        when {
            downloading.any { it.id == task.id } -> {
                val index = downloading.indexOfFirst { it.id == task.id }
                if (index >= 0) {
                    downloading[index] = task
                    downloadingAdapter.notifyItemChanged(index)
                }
            }
            completed.any { it.id == task.id } -> {
                val index = completed.indexOfFirst { it.id == task.id }
                if (index >= 0) {
                    completed[index] = task
                    completedAdapter.notifyItemChanged(index)
                }
            }
            // ... å…¶ä»–åˆ†ç»„
        }
    }
}
```

### ğŸ¨ UIæ›´æ–°æœ€ä½³å®è·µ

#### 1. æŒ‰é’®çŠ¶æ€ç®¡ç†

```kotlin
private fun bindButtonUI(task: DownloadTask) {
    when (task.status) {
        DownloadStatus.DOWNLOADING -> {
            button.text = "${task.progress}%"
            button.setProgress(task.progress)
            button.isEnabled = true
        }
        DownloadStatus.PAUSED -> {
            button.text = "ç»§ç»­"
            button.setProgress(task.progress)
            button.isEnabled = true
        }
        DownloadStatus.WAITING, DownloadStatus.PENDING -> {
            button.text = "ç­‰å¾…ä¸­"
            button.isEnabled = true
        }
        DownloadStatus.COMPLETED -> {
            button.text = "å®‰è£…"
            button.setProgress(100)
            button.isEnabled = true
        }
        DownloadStatus.FAILED -> {
            button.text = "é‡è¯•"
            button.isEnabled = true
        }
        else -> {
            button.text = "ä¸‹è½½"
            button.setProgress(0)
            button.isEnabled = true
        }
    }
}
```

#### 2. è¿›åº¦æ˜¾ç¤ºä¼˜åŒ–

```kotlin
private fun updateProgressDisplay(task: DownloadTask, progress: Int, speed: Long) {
    // æ›´æ–°è¿›åº¦æ¡
    progressBar.progress = progress

    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤ºï¼ˆæ ¼å¼åŒ–ï¼‰
    speedText.text = formatSpeed(speed)

    // æ›´æ–°å‰©ä½™æ—¶é—´
    val remainingTime = calculateRemainingTime(task.totalSize, task.currentSize, speed)
    timeText.text = formatTime(remainingTime)
}

private fun formatSpeed(bytesPerSecond: Long): String {
    return when {
        bytesPerSecond >= 1024 * 1024 -> "${bytesPerSecond / (1024 * 1024)} MB/s"
        bytesPerSecond >= 1024 -> "${bytesPerSecond / 1024} KB/s"
        else -> "$bytesPerSecond B/s"
    }
}
```

#### 3. é”™è¯¯å¤„ç†

```kotlin
private fun handleDownloadError(task: DownloadTask, error: DownloadError) {
    when (error) {
        DownloadError.NetworkError -> {
            showErrorDialog("ç½‘ç»œé”™è¯¯", "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•")
        }
        DownloadError.StorageError -> {
            showErrorDialog("å­˜å‚¨ç©ºé—´ä¸è¶³", "è¯·æ¸…ç†å­˜å‚¨ç©ºé—´åé‡è¯•")
        }
        DownloadError.FileError -> {
            showErrorDialog("æ–‡ä»¶é”™è¯¯", "æ–‡ä»¶å¯èƒ½å·²æŸåï¼Œè¯·é‡æ–°ä¸‹è½½")
        }
        else -> {
            showErrorDialog("ä¸‹è½½å¤±è´¥", "æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•")
        }
    }
}
```

### ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. å†…å­˜ç®¡ç†

```kotlin
class DownloadActivity : AppCompatActivity() {

    private var flowListener: FlowDownloadListener? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // å»¶è¿Ÿåˆå§‹åŒ–ç›‘å¬å™¨
        flowListener = DownloadManager.flowListener
    }

    override fun onDestroy() {
        super.onDestroy()
        // Flowç›‘å¬å™¨ä¼šè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
        flowListener = null
    }
}
```

#### 2. åˆ—è¡¨ä¼˜åŒ–

```kotlin
// ä½¿ç”¨ DiffUtil ä¼˜åŒ–åˆ—è¡¨æ›´æ–°
class DownloadTaskDiffCallback : DiffUtil.Callback() {
    override fun areItemsTheSame(oldItemPosition: Int, newItemPosition: Int): Boolean {
        return oldList[oldItemPosition].id == newList[newItemPosition].id
    }

    override fun areContentsTheSame(oldItemPosition: Int, newItemPosition: Int): Boolean {
        val oldTask = oldList[oldItemPosition]
        val newTask = newList[newItemPosition]
        return oldTask.status == newTask.status &&
                oldTask.progress == newTask.progress &&
                oldTask.speed == newTask.speed
    }
}
```

#### 3. ç½‘ç»œçŠ¶æ€ç›‘å¬

```kotlin
// ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œè‡ªåŠ¨æš‚åœ/æ¢å¤ä¸‹è½½
private fun setupNetworkListener() {
    val connectivityManager = getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
    val networkCallback = object : ConnectivityManager.NetworkCallback() {
        override fun onAvailable(network: Network) {
            // ç½‘ç»œæ¢å¤ï¼Œå¯ä»¥æ¢å¤ä¸‹è½½
            DownloadManager.resumeAll()
        }

        override fun onLost(network: Network) {
            // ç½‘ç»œæ–­å¼€ï¼Œæš‚åœä¸‹è½½
            DownloadManager.pauseAll()
        }
    }

    connectivityManager.registerDefaultNetworkCallback(networkCallback)
}
```

### ğŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ¥å…¥æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥ï¼š

1. **å¿«é€Ÿé›†æˆ**ï¼šæŒ‰ç…§æ–‡æ¡£æ­¥éª¤å¿«é€Ÿé›†æˆä¸‹è½½ç®¡ç†å™¨
2. **é«˜æ•ˆç›‘å¬**ï¼šä½¿ç”¨Flowç›‘å¬å™¨å®ç°å“åº”å¼UIæ›´æ–°
3. **ä¼˜åŒ–æ€§èƒ½**ï¼šé€šè¿‡é˜²æŠ–ã€åˆ†ç»„ç®¡ç†ç­‰ç­–ç•¥ä¼˜åŒ–åˆ—è¡¨åˆ·æ–°æ€§èƒ½
4. **æå‡ä½“éªŒ**ï¼šé€šè¿‡åˆç†çš„çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†æå‡ç”¨æˆ·ä½“éªŒ

è¿™ä¸ªä¸‹è½½ç®¡ç†å™¨æä¾›äº†ä¼ä¸šçº§çš„åŠŸèƒ½ç‰¹æ€§ï¼Œæ”¯æŒå¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½ã€æ–­ç‚¹ç»­ä¼ ã€ä¼˜å…ˆçº§è°ƒåº¦ç­‰ï¼Œèƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„ä¸‹è½½åœºæ™¯éœ€æ±‚ã€‚
