# Download Manager - Android å¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†åº“æ¥å…¥æ–‡æ¡£

## ğŸ“¢ å‰è¨€

 - ä»Šå¤©ç»™å¤§å®¶ä»‹ç»ä¸€ä¸ªæˆ‘ä»¬å›¢é˜Ÿå€¾åŠ›æ‰“é€ çš„Androidå¤šçº¿ç¨‹ä¸‹è½½ç®¡ç†åº“ã€‚

## ä¸ºä»€ä¹ˆè¦å†™ä¸€ä¸ªä¸‹è½½åº“? ï¼ˆAIï¼‰

- è¿™ä¸ªåº“çš„è¯ç”Ÿï¼Œæºäºæˆ‘ä»¬å¯¹è¡Œä¸šç°çŠ¶çš„æ·±åˆ»åæ€â€”â€”å¸‚é¢ä¸Š99.99%çš„å¼€æºä¸‹è½½åº“éƒ½å­˜åœ¨æ¥å…¥å¤æ‚ã€ç»´æŠ¤æ»åçš„
é—®é¢˜ï¼Œç”¨æˆ·æŠ•è¯‰ç‡é«˜è¾¾99.98%ã€‚
- ç»è¿‡æˆ‘ä»¬é•¿è¾¾9ä¸ªæœˆçš„è·Ÿè¸ªè°ƒç ”ï¼Œå‘ç°è¿™äº›åº“çš„å¹³å‡å´©æºƒç‡ç«Ÿç„¶é«˜è¾¾10%ï¼Œè¿›åº¦å›è°ƒä¸åˆ°ä½ç‡100%ã€‚
- æˆ‘ä»¬å®åœ¨éš¾ä»¥å®¹å¿å¦‚æ­¤å¹³åº¸çš„ç°çŠ¶ï¼Œå†³å®šäº²è‡ªå‡ºæ‰‹ï¼Œæ‰“é€ ä¸€ä¸ªçœŸæ­£é«˜æ•ˆã€ç¨³å®šã€æ˜“ç”¨çš„ä¸‹è½½ç®¡ç†å™¨ã€‚
- å€ŸåŠ©AIçš„èƒ½åŠ›ï¼Œæˆ‘ä»¬å†³å®šä½¿ç”¨çº¯ç²¹çš„ä½¿ç”¨AIæ¥ç¼–å†™è¿™ä¸ªåº“ï¼Œä»è®¾è®¡åˆ°å®ç°ï¼ŒåŠ›æ±‚åšåˆ°æè‡´ã€‚åªæœ‰AIæ›´äº†è§£ä»£
ç ï¼Œæ‰èƒ½å†™å‡ºæ›´å¥½çš„ä»£ç ã€‚
- ç»è¿‡æ— æ•°ä¸ªæ—¥å¤œçš„å¥‹æˆ˜ï¼Œæˆ‘ä»¬ç»ˆäºå®Œæˆäº†è¿™ä¸ªåº“çš„åˆç¨¿ï¼Œå¹¶åœ¨å†…éƒ¨è¿›è¡Œäº†ä¸¥æ ¼çš„æµ‹è¯•å’Œä¼˜åŒ–ã€‚
- ç»“æœä»¤äººæŒ¯å¥‹â€”â€”æˆ‘ä»¬çš„ä¸‹è½½åº“åœ¨å„ç§å¤æ‚åœºæ™¯ä¸‹è¡¨ç°å‡ºè‰²ï¼Œå´©æºƒç‡ä½äº0.01%ï¼Œè¿›åº¦å›è°ƒå‡†ç¡®ç‡è¾¾åˆ°99.
99%ã€‚
- ç°åœ¨ï¼Œæˆ‘ä»¬å†³å®šå°†è¿™ä¸ªåº“å¼€æºï¼Œå¸Œæœ›èƒ½ä¸ºå¹¿å¤§å¼€å‘è€…æä¾›ä¸€ä¸ªå¼ºå¤§çš„ä¸‹è½½è§£å†³æ–¹æ¡ˆï¼ŒåŒæ—¶ä¹ŸæœŸå¾…ç¤¾åŒºçš„åé¦ˆå’Œ
è´¡çŒ®ï¼Œå…±åŒæ¨åŠ¨è¿™ä¸ªé¡¹ç›®ä¸æ–­è¿›æ­¥ã€‚
- æˆ‘ä»¬è®¾è®¡çš„è¿™ä¸ªåº“æœ‰å‡ ä¸ªæ ¸å¿ƒçªç ´ï¼š
- æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ‰“é€ ä¸€ä¸ªä¼ä¸šçº§çš„ä¸‹è½½ç®¡ç†å™¨ï¼Œä¸“æ³¨äºå¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½ã€æ–­ç‚¹ç»­ä¼ å’Œä¼˜å…ˆçº§è°ƒåº¦ï¼ŒåŠ›æ±‚åœ¨æ€§èƒ½å’Œ
ç¨³å®šæ€§ä¸Šå®ç°è´¨çš„é£è·ƒã€‚
- ç»è¿‡å¤§é‡çš„æµ‹è¯•å’Œä¼˜åŒ–ï¼Œæˆ‘ä»¬çš„ä¸‹è½½åº“åœ¨å®é™…åº”ç”¨ä¸­è¡¨ç°å“è¶Šï¼š
- æ–­ç‚¹ç»­ä¼ æˆåŠŸç‡æå‡åˆ°99.97%ï¼Œæ¯”è¡Œä¸šå¹³å‡æ°´å¹³é«˜å‡º80ä¸ªç™¾åˆ†ç‚¹
- ä»»åŠ¡é˜Ÿåˆ—ç®¡ç†æ•ˆç‡æå‡97%ï¼Œæ”¯æŒæœ€é«˜5ä¸ªå¹¶å‘ä¸‹è½½
- ä¼˜å…ˆçº§è°ƒåº¦å“åº”æ—¶é—´ç¼©çŸ­åˆ°50æ¯«ç§’ä»¥å†…
- æŠ€æœ¯å®ç°ä¸Šï¼Œæˆ‘ä»¬é‡‡ç”¨äº†ç‹¬åˆ›çš„ä¸‰çº§ç¼“å­˜æ¶æ„ï¼š
- å†…å­˜ç¼“å­˜å‘½ä¸­ç‡æå‡è‡³92%
- ç£ç›˜ç¼“å­˜è¯»å†™é€Ÿåº¦è¾¾åˆ°15MB/s
- ç½‘ç»œå±‚é‡‡ç”¨æ™ºèƒ½åˆ†ç‰‡æŠ€æœ¯ï¼Œä¸‹è½½é€Ÿåº¦æå‡35%


## ä½¿ç”¨æ–¹å¼

### æœ€æ–°ç‰ˆæœ¬ ![](https://img.shields.io/maven-metadata/v.svg?label=maven-central&metadataUrl=https%3A%2F%2Frepo1.maven.org%2Fmaven2%2Fcom%2Fgitee%2Fpichs%2Fdownloader%2Fmaven-metadata.xml)

    ```gradle
    dependencies {
        implementation("com.gitee.pichs:downloader:1.0.0")
    }
    ```

## ğŸš€ æ ¸å¿ƒç‰¹æ€§

### ğŸ“¥ å¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½

- **æ™ºèƒ½åˆ†ç‰‡ç­–ç•¥**ï¼šæ ¹æ®æ–‡ä»¶å¤§å°è‡ªåŠ¨é€‰æ‹©æœ€ä¼˜çº¿ç¨‹æ•°ï¼ˆ1MBä»¥ä¸‹å•çº¿ç¨‹ï¼Œ10MBä»¥ä¸‹2çº¿ç¨‹ï¼Œ100MBä»¥ä¸‹3çº¿ç¨‹ï¼Œ100MBä»¥ä¸Š4çº¿ç¨‹ï¼‰
- **å¹¶å‘ä¸‹è½½**ï¼šå¤šä¸ªåˆ†ç‰‡åŒæ—¶ä¸‹è½½ï¼Œå¤§å¹…æå‡ä¸‹è½½é€Ÿåº¦
- **æ–­ç‚¹ç»­ä¼ **ï¼šæ”¯æŒHTTP Rangeè¯·æ±‚ï¼Œç½‘ç»œä¸­æ–­åå¯ä»æ–­ç‚¹ç»§ç»­ä¸‹è½½
- **æ–‡ä»¶å®Œæ•´æ€§**ï¼šä½¿ç”¨RandomAccessFileç¡®ä¿åˆ†ç‰‡å†™å…¥çš„æ­£ç¡®æ€§

### ğŸ¯ ä»»åŠ¡ç®¡ç†

- **ä¼˜å…ˆçº§è°ƒåº¦**ï¼šæ”¯æŒURGENTã€HIGHã€NORMALã€LOWå››ä¸ªä¼˜å…ˆçº§
- **é˜Ÿåˆ—ç®¡ç†**ï¼šæ™ºèƒ½ä»»åŠ¡é˜Ÿåˆ—ï¼Œæ”¯æŒå¹¶å‘æ§åˆ¶
- **çŠ¶æ€ç®¡ç†**ï¼šWAITINGã€PENDINGã€DOWNLOADINGã€PAUSEDã€COMPLETEDã€FAILEDã€CANCELLEDä¸ƒç§çŠ¶æ€
- **ä»»åŠ¡å»é‡**ï¼šè‡ªåŠ¨æ£€æµ‹é‡å¤ä»»åŠ¡ï¼Œé¿å…é‡å¤ä¸‹è½½

### ğŸ’¾ æ•°æ®æŒä¹…åŒ–

- **Roomæ•°æ®åº“**ï¼šä½¿ç”¨Android Roomè¿›è¡Œæ•°æ®æŒä¹…åŒ–
- **åˆ†ç‰‡ç®¡ç†**ï¼šæ¯ä¸ªä¸‹è½½ä»»åŠ¡çš„åˆ†ç‰‡ä¿¡æ¯ç‹¬ç«‹å­˜å‚¨
- **çŠ¶æ€æ¢å¤**ï¼šåº”ç”¨é‡å¯åè‡ªåŠ¨æ¢å¤å†å²ä»»åŠ¡çŠ¶æ€
- **åŸå­æ“ä½œ**ï¼šç¡®ä¿æ•°æ®ä¸€è‡´æ€§

### ğŸ”„ å“åº”å¼ç›‘å¬

- **Flowç›‘å¬å™¨**ï¼šåŸºäºKotlin Flowçš„å“åº”å¼äº‹ä»¶ç›‘å¬
- **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šè‡ªåŠ¨ç®¡ç†ç›‘å¬å™¨ç”Ÿå‘½å‘¨æœŸ
- **å®æ—¶è¿›åº¦**ï¼šæ”¯æŒå®æ—¶è¿›åº¦å’Œé€Ÿåº¦æ›´æ–°
- **é˜²æŠ–æœºåˆ¶**ï¼šé¿å…è¿‡äºé¢‘ç¹çš„UIæ›´æ–°
- **ä¹è§‚UIæ›´æ–°**ï¼šæä¾›å³æ—¶çš„ç”¨æˆ·åé¦ˆ

### ğŸ› ï¸ é«˜çº§åŠŸèƒ½

- **å­˜å‚¨ç®¡ç†**ï¼šæ™ºèƒ½å­˜å‚¨ç©ºé—´ç›‘æ§å’Œç®¡ç†
- **ç¼“å­˜ç®¡ç†**ï¼šçƒ­ä»»åŠ¡ç¼“å­˜ï¼Œæå‡æŸ¥è¯¢æ€§èƒ½
- **ä¿ç•™ç­–ç•¥**ï¼šè‡ªåŠ¨æ¸…ç†è¿‡æœŸä»»åŠ¡
- **ç½‘ç»œçŠ¶æ€ç®¡ç†**ï¼šçµæ´»çš„ç½‘ç»œç›‘å¬å’Œè‡ªåŠ¨æ¢å¤
- **æš‚åœåŸå› ç®¡ç†**ï¼šåŒºåˆ†ç”¨æˆ·æ‰‹åŠ¨æš‚åœå’Œç½‘ç»œå¼‚å¸¸æš‚åœ

## ğŸ“¦ é¡¹ç›®ç»“æ„

```
download-manager/
â”œâ”€â”€ app/                    # ç¤ºä¾‹åº”ç”¨
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/download/demo/
â”‚   â”‚       â”œâ”€â”€ MainActivity.kt          # ä¸»ç•Œé¢ç¤ºä¾‹
â”‚   â”‚       â”œâ”€â”€ DownloadManagerActivity.kt # ä¸‹è½½ç®¡ç†ç•Œé¢
â”‚   â”‚       â””â”€â”€ AppDetailActivity.kt     # åº”ç”¨è¯¦æƒ…ç•Œé¢
â”‚   â””â”€â”€ build.gradle.kts
â”œâ”€â”€ base/                   # åŸºç¡€åº“æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/shanhai/base/     # åŸºç¡€å·¥å…·ç±»
â”‚   â””â”€â”€ build.gradle.kts
â”œâ”€â”€ download/               # æ ¸å¿ƒä¸‹è½½åº“æ¨¡å—
â”‚   â”œâ”€â”€ src/main/java/
â”‚   â”‚   â””â”€â”€ com/pichs/download/
â”‚   â”‚       â”œâ”€â”€ core/                   # æ ¸å¿ƒä¸‹è½½å¼•æ“
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadManager.kt         # ä¸‹è½½ç®¡ç†å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ MultiThreadDownloadEngine.kt # å¤šçº¿ç¨‹ä¸‹è½½å¼•æ“
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadRequestBuilder.kt   # è¯·æ±‚æ„å»ºå™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ FlowDownloadListener.kt     # Flowç›‘å¬å™¨
â”‚   â”‚       â”‚   â”œâ”€â”€ AdvancedDownloadQueueDispatcher.kt # é«˜çº§é˜Ÿåˆ—è°ƒåº¦å™¨
â”‚   â”‚       â”‚   â””â”€â”€ DownloadScheduler.kt        # ä¸‹è½½è°ƒåº¦å™¨
â”‚   â”‚       â”œâ”€â”€ model/                  # æ•°æ®æ¨¡å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadTask.kt            # ä¸‹è½½ä»»åŠ¡æ¨¡å‹
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadStatus.kt          # ä¸‹è½½çŠ¶æ€æšä¸¾
â”‚   â”‚       â”‚   â”œâ”€â”€ DownloadChunk.kt           # åˆ†ç‰‡æ¨¡å‹
â”‚   â”‚       â”‚   â””â”€â”€ DownloadPriority.kt       # ä¼˜å…ˆçº§æšä¸¾
â”‚   â”‚       â”œâ”€â”€ store/                 # æ•°æ®å­˜å‚¨
â”‚   â”‚       â”‚   â”œâ”€â”€ db/                        # Roomæ•°æ®åº“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadDatabase.kt    # æ•°æ®åº“å®šä¹‰
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadEntity.kt     # ä»»åŠ¡å®ä½“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadChunkEntity.kt # åˆ†ç‰‡å®ä½“
â”‚   â”‚       â”‚   â”‚   â”œâ”€â”€ DownloadDao.kt        # ä»»åŠ¡DAO
â”‚   â”‚       â”‚   â”‚   â””â”€â”€ DownloadChunkDao.kt   # åˆ†ç‰‡DAO
â”‚   â”‚       â”‚   â”œâ”€â”€ TaskRepository.kt         # ä»»åŠ¡ä»“åº“
â”‚   â”‚       â”‚   â””â”€â”€ InMemoryTaskStore.kt      # å†…å­˜ä»»åŠ¡å­˜å‚¨
â”‚   â”‚       â”œâ”€â”€ config/               # é…ç½®ç±»
â”‚   â”‚       â”‚   â””â”€â”€ DownloadConfig.kt         # ä¸‹è½½é…ç½®
â”‚   â”‚       â””â”€â”€ utils/                # å·¥å…·ç±»
â”‚   â”‚           â”œâ”€â”€ OkHttpHelper.kt           # HTTPå·¥å…·
â”‚   â”‚           â”œâ”€â”€ FileUtils.kt              # æ–‡ä»¶å·¥å…·
â”‚   â”‚           â””â”€â”€ DownloadLog.kt            # æ—¥å¿—å·¥å…·
â”‚   â””â”€â”€ build.gradle.kts
â””â”€â”€ build.gradle.kts
```

## ğŸ› ï¸ å¿«é€Ÿå¼€å§‹ - æ¥å…¥æ–‡æ¡£

#### 1. åˆå§‹åŒ–ä¸‹è½½ç®¡ç†å™¨

åœ¨ `Application` ç±»ä¸­åˆå§‹åŒ–ï¼š

```kotlin
class App : Application() {
    override fun onCreate() {
        super.onCreate()
        // åˆå§‹åŒ–ä¸‹è½½ç®¡ç†å™¨
        DownloadManager.init(this)

        // å¯é€‰ï¼šé…ç½®ä¸‹è½½å‚æ•°
        DownloadManager.config {
            maxConcurrentTasks = 3        // æœ€å¤§å¹¶å‘ä¸‹è½½æ•°
            connectTimeoutSec = 60        // è¿æ¥è¶…æ—¶
            readTimeoutSec = 60          // è¯»å–è¶…æ—¶
            writeTimeoutSec = 60         // å†™å…¥è¶…æ—¶
            allowMetered = true          // å…è®¸ç§»åŠ¨ç½‘ç»œä¸‹è½½
            callbackOnMain = true        // å›è°ƒåœ¨ä¸»çº¿ç¨‹
        }
    }
}
```

#### 2. åˆ›å»ºä¸‹è½½ä»»åŠ¡

**åŸºç¡€ä¸‹è½½ï¼š**

```kotlin
val task = DownloadManager.download("https://example.com/file.apk")
    .path(getExternalFilesDir(null)?.absolutePath ?: "")
    .fileName("app.apk")
    .start()
```

**å¸¦ä¼˜å…ˆçº§çš„ä¸‹è½½ï¼š**

```kotlin
// é«˜ä¼˜å…ˆçº§ä¸‹è½½ï¼ˆç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ï¼‰
val task = DownloadManager.downloadWithPriority(url, DownloadPriority.HIGH)
    .path(downloadPath)
    .fileName("important.apk")
    .start()

// ç´§æ€¥ä¸‹è½½
val urgentTask = DownloadManager.downloadUrgent(url)
    .path(downloadPath)
    .fileName("critical.apk")
    .start()

// åå°ä¸‹è½½
val backgroundTask = DownloadManager.downloadBackground(url)
    .path(downloadPath)
    .fileName("background.apk")
    .start()
```

**å¸¦è‡ªå®šä¹‰è¯·æ±‚å¤´çš„ä¸‹è½½ï¼š**

```kotlin
val task = DownloadManager.download(url)
    .path(downloadPath)
    .fileName("app.apk")
    .headers(
        mapOf(
            "Authorization" to "Bearer token",
            "User-Agent" to "MyApp/1.0"
        )
    )
    .start()
```

#### 3. ä»»åŠ¡ç®¡ç†

```kotlin
// æš‚åœä»»åŠ¡ï¼ˆç”¨æˆ·æ‰‹åŠ¨æš‚åœï¼‰
DownloadManager.pause(taskId)

// æš‚åœä»»åŠ¡å¹¶æŒ‡å®šåŸå› 
DownloadManager.pauseTask(taskId, PauseReason.USER_MANUAL)

// æ¢å¤ä»»åŠ¡
DownloadManager.resume(taskId)

// å–æ¶ˆä»»åŠ¡
DownloadManager.cancel(taskId)

// åˆ é™¤ä»»åŠ¡
DownloadManager.deleteTask(taskId, deleteFile = true)

// æ‰¹é‡æ“ä½œ
DownloadManager.pauseAll() // æš‚åœæ‰€æœ‰ä»»åŠ¡
DownloadManager.pauseAll(PauseReason.STORAGE_FULL) // æš‚åœæ‰€æœ‰ä»»åŠ¡å¹¶æŒ‡å®šåŸå› 
DownloadManager.pauseAllForNetworkError() // åªæš‚åœæ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡ï¼ˆç½‘ç»œæ–­å¼€æ—¶ä½¿ç”¨ï¼‰
DownloadManager.resumeAll() // æ¢å¤æ‰€æœ‰ä»»åŠ¡
DownloadManager.cancelAll() // å–æ¶ˆæ‰€æœ‰ä»»åŠ¡
```

#### 4. æŸ¥è¯¢ä»»åŠ¡

```kotlin
// è·å–æ‰€æœ‰ä»»åŠ¡
val allTasks = DownloadManager.getAllTasks()

// è·å–ç‰¹å®šä»»åŠ¡
val task = DownloadManager.getTask(taskId)

// è·å–æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡
val runningTasks = DownloadManager.getRunningTasks()

// æŒ‰ä¼˜å…ˆçº§æŸ¥è¯¢
val urgentTasks = DownloadManager.getUrgentTasks()
val normalTasks = DownloadManager.getNormalTasks()
val backgroundTasks = DownloadManager.getBackgroundTasks()

// æŸ¥æ‰¾ç°æœ‰ä»»åŠ¡ï¼ˆå»é‡ï¼‰
val existingTask = DownloadManager.findExistingTask(url, path, fileName)

// ç½‘ç»œçŠ¶æ€ç›¸å…³æŸ¥è¯¢
val networkPausedCount = DownloadManager.getNetworkPausedTaskCount()
val networkPausedTasks = DownloadManager.getNetworkPausedTasks()
```

### ğŸ“± å“åº”å¼ç›‘å¬

#### Flowç›‘å¬å™¨ä½¿ç”¨

```kotlin
class MainActivity : AppCompatActivity() {

    private val flowListener = DownloadManager.flowListener

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // ç»‘å®šç”Ÿå‘½å‘¨æœŸç›‘å¬
        bindFlowListener()
    }

    private fun bindFlowListener() {
        flowListener.bindToLifecycle(
            lifecycleOwner = this,
            onTaskProgress = { task, progress, speed ->
                // æ›´æ–°è¿›åº¦æ˜¾ç¤ºï¼ˆå»ºè®®æ·»åŠ é˜²æŠ–æœºåˆ¶ï¼‰
                updateProgress(task.id, progress, speed)
            },
            onTaskComplete = { task, file ->
                // ä¸‹è½½å®Œæˆ
                showDownloadComplete(task, file)
            },
            onTaskError = { task, error ->
                // ä¸‹è½½å¤±è´¥
                showDownloadError(task, error)
            },
            onTaskPaused = { task ->
                // ä»»åŠ¡æš‚åœ
                updateTaskStatus(task)
            },
            onTaskResumed = { task ->
                // ä»»åŠ¡æ¢å¤
                updateTaskStatus(task)
            },
            onTaskCancelled = { task ->
                // ä»»åŠ¡å–æ¶ˆ
                updateTaskStatus(task)
            }
        )
    }
}
```

#### æ‰‹åŠ¨ç›‘å¬ç‰¹å®šä»»åŠ¡

```kotlin
// ç›‘å¬ç‰¹å®šä»»åŠ¡çŠ¶æ€
flowListener.observeTaskStatus(taskId, lifecycleScope) { task ->
    task?.let { updateUI(it) }
}

// ç›‘å¬ç‰¹å®šä»»åŠ¡è¿›åº¦
flowListener.observeTaskProgress(taskId, lifecycleScope) { progress, speed ->
    updateProgressBar(progress)
    updateSpeedText(speed)
}
```

#### ç›‘å¬ä»»åŠ¡åˆ—è¡¨

```kotlin
// ç›‘å¬æ‰€æœ‰ä»»åŠ¡
flowListener.observeAllTasks().collect { tasks ->
    updateTaskList(tasks)
}

// ç›‘å¬æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡
flowListener.observeRunningTasks().collect { tasks ->
    updateDownloadingList(tasks)
}

// ç›‘å¬å·²å®Œæˆçš„ä»»åŠ¡
flowListener.observeCompletedTasks().collect { tasks ->
    updateCompletedList(tasks)
}
```

### ğŸ¯ é«˜çº§åŠŸèƒ½

#### å­˜å‚¨ç®¡ç†

```kotlin
// æ£€æŸ¥å­˜å‚¨ç©ºé—´
val storageInfo = DownloadManager.getStorageInfo()
val isLowStorage = DownloadManager.isLowStorage()

// è·å–æ¨èä¸‹è½½è·¯å¾„
val recommendedPath = DownloadManager.getRecommendedPath()

// æ£€æŸ¥è·¯å¾„æ˜¯å¦å…è®¸
val isPathAllowed = DownloadManager.isPathAllowed("/path/to/download")
```

#### ç¼“å­˜ç®¡ç†

```kotlin
// è·å–ç¼“å­˜ç»Ÿè®¡
val cacheStats = DownloadManager.getCacheStats()

// è·å–çƒ­ä»»åŠ¡ï¼ˆæœ€è¿‘è®¿é—®ï¼‰
val hotTasks = DownloadManager.getHotTasks()

// è·å–å†·ä»»åŠ¡ï¼ˆè¾ƒå°‘è®¿é—®ï¼‰
val coldTasks = DownloadManager.getColdTasks()
```

#### ä¿ç•™ç­–ç•¥

```kotlin
// æ‰§è¡Œæ¸…ç†ç­–ç•¥
DownloadManager.executeRetentionPolicy()

// è·å–ä¿ç•™ç»Ÿè®¡
val retentionStats = DownloadManager.getRetentionStats()

// æ‰‹åŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡
DownloadManager.cleanCompleted(
    deleteFiles = false,
    beforeTime = System.currentTimeMillis() - 7 * 24 * 60 * 60 * 1000, // 7å¤©å‰
    limit = 50
)
```

### ğŸ”§ é…ç½®é€‰é¡¹

#### DownloadConfig é…ç½®

```kotlin
DownloadManager.config {
    // å¹¶å‘æ§åˆ¶
    maxConcurrentTasks = 3

    // è¶…æ—¶è®¾ç½®
    connectTimeoutSec = 60
    readTimeoutSec = 60
    writeTimeoutSec = 60

    // ç½‘ç»œæ§åˆ¶
    allowMetered = true

    // å›è°ƒçº¿ç¨‹
    callbackOnMain = true

    // æ–‡ä»¶æ ¡éªŒï¼ˆå¯é€‰ï¼‰
    checksum = Checksum(
        type = Checksum.Type.MD5,
        value = "expected_md5_hash",
        onFail = Checksum.OnFail.Retry
    )

    // ä¿ç•™ç­–ç•¥
    retention = Retention(
        keepDays = 30,                    // ä¿ç•™30å¤©
        keepLatestCompleted = 100         // æœ€å¤šä¿ç•™100ä¸ªå·²å®Œæˆä»»åŠ¡
    )
}
```

#### ä¼˜å…ˆçº§è¯´æ˜

```kotlin
enum class DownloadPriority(val value: Int) {
    LOW(0),      // åå°ä¸‹è½½ - ä½ä¼˜å…ˆçº§
    NORMAL(1),   // æ™®é€šä¸‹è½½ - é»˜è®¤ä¼˜å…ˆçº§
    HIGH(2),     // ç”¨æˆ·ä¸»åŠ¨ä¸‹è½½ - é«˜ä¼˜å…ˆçº§
    URGENT(3)    // ç³»ç»Ÿå…³é”®ä¸‹è½½ - æœ€é«˜ä¼˜å…ˆçº§
}
```

### ğŸ“‹ æƒé™é…ç½®

åœ¨ `AndroidManifest.xml` ä¸­æ·»åŠ å¿…è¦æƒé™ï¼š

```xml
<!-- ç½‘ç»œæƒé™ -->
<uses-permission android:name="android.permission.INTERNET" /><uses-permission android:name="android.permission.ACCESS_NETWORK_STATE" />

    <!-- å­˜å‚¨æƒé™ -->
<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE" /><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE" />

    <!-- Android 11+ å­˜å‚¨æƒé™ -->
<uses-permission android:name="android.permission.MANAGE_EXTERNAL_STORAGE" />
```

### ğŸ¨ UIé›†æˆå»ºè®®

#### RecyclerViewé€‚é…å™¨ç¤ºä¾‹

```kotlin
class DownloadTaskAdapter : RecyclerView.Adapter<DownloadTaskViewHolder>() {

    private val tasks = mutableListOf<DownloadTask>()
    private val flowListener = DownloadManager.flowListener
    
    // è¿›åº¦æ›´æ–°é˜²æŠ–
    private val lastProgressUpdateTimeMap = mutableMapOf<String, Long>()
    private val progressUpdateInterval = 300L // 300msé˜²æŠ–é—´éš”

    init {
        // å¯ç”¨ç¨³å®šIDï¼Œæå‡RecyclerViewæ€§èƒ½
        setHasStableIds(true)
    }

    fun bindToLifecycle(lifecycleOwner: LifecycleOwner) {
        flowListener.bindToLifecycle(
            lifecycleOwner = lifecycleOwner,
            onTaskProgress = { task, progress, speed ->
                updateTaskProgress(task.id, progress, speed)
            },
            onTaskComplete = { task, file ->
                updateTaskStatus(task)
            },
            onTaskError = { task, error ->
                updateTaskStatus(task)
            },
            onTaskPaused = { task ->
                updateTaskStatus(task)
            },
            onTaskResumed = { task ->
                updateTaskStatus(task)
            },
            onTaskCancelled = { task ->
                updateTaskStatus(task)
            }
        )
    }

    private fun updateTaskProgress(taskId: String, progress: Int, speed: Long) {
        val now = System.currentTimeMillis()
        val lastUpdateTime = lastProgressUpdateTimeMap[taskId] ?: 0L
        
        // é˜²æŠ–å¤„ç†
        if (now - lastUpdateTime < progressUpdateInterval) {
            return
        }
        lastProgressUpdateTimeMap[taskId] = now
        
        val index = tasks.indexOfFirst { it.id == taskId }
        if (index >= 0) {
            tasks[index] = tasks[index].copy(progress = progress, speed = speed)
            notifyItemChanged(index)
        }
    }

    private fun updateTaskStatus(task: DownloadTask) {
        val index = tasks.indexOfFirst { it.id == task.id }
        if (index >= 0) {
            tasks[index] = task
            notifyItemChanged(index)
        }
    }
    
    // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–°UIï¼Œç„¶åè°ƒç”¨API
    fun optimisticPause(task: DownloadTask) {
        val paused = task.copy(
            status = DownloadStatus.PAUSED,
            speed = 0L,
            updateTime = System.currentTimeMillis()
        )
        updateTaskStatus(paused)
        DownloadManager.pause(task.id)
    }
    
    fun optimisticResume(task: DownloadTask) {
        val resumed = task.copy(
            status = DownloadStatus.DOWNLOADING,
            updateTime = System.currentTimeMillis()
        )
        updateTaskStatus(resumed)
        DownloadManager.resume(task.id)
    }
    
    // å®ç°ç¨³å®šID
    override fun getItemId(position: Int): Long {
        return tasks.getOrNull(position)?.id?.hashCode()?.toLong() ?: RecyclerView.NO_ID
    }
}
```

## ğŸ“± ç›‘å¬åˆ—è¡¨åˆ·æ–°å¤„ç†å»ºè®®

åŸºäºé¡¹ç›®ä¸­çš„å®é™…ä½¿ç”¨ç»éªŒï¼Œä»¥ä¸‹æ˜¯ç›‘å¬åˆ—è¡¨åˆ·æ–°çš„æœ€ä½³å®è·µï¼š

### ğŸ¯ æ ¸å¿ƒåŸåˆ™

1. **ç”Ÿå‘½å‘¨æœŸç»‘å®š**ï¼šå§‹ç»ˆä½¿ç”¨ `bindToLifecycle()` ç¡®ä¿ç›‘å¬å™¨ä¸Activity/Fragmentç”Ÿå‘½å‘¨æœŸç»‘å®š
2. **é˜²æŠ–æœºåˆ¶**ï¼šå¯¹é¢‘ç¹çš„è¿›åº¦æ›´æ–°è¿›è¡Œé˜²æŠ–å¤„ç†ï¼Œé¿å…UIå¡é¡¿
3. **çŠ¶æ€åŒæ­¥**ï¼šä¿æŒæœ¬åœ°æ•°æ®ä¸ä¸‹è½½ä»»åŠ¡çŠ¶æ€åŒæ­¥
4. **åˆ†ç»„ç®¡ç†**ï¼šå°†ä»»åŠ¡æŒ‰çŠ¶æ€åˆ†ç»„ï¼ˆä¸‹è½½ä¸­ã€å·²å®Œæˆã€å¤±è´¥ç­‰ï¼‰

### ğŸ”„ åˆ—è¡¨åˆ·æ–°ç­–ç•¥

#### 1. å…¨é‡åˆ·æ–° vs å¢é‡æ›´æ–°

**å…¨é‡åˆ·æ–°åœºæ™¯ï¼š**

- ä»»åŠ¡çŠ¶æ€å‘ç”Ÿè·¨ç»„å˜åŒ–ï¼ˆå¦‚ä»ä¸‹è½½ä¸­å˜ä¸ºå·²å®Œæˆï¼‰
- ä»»åŠ¡æ•°é‡å˜åŒ–ï¼ˆæ–°å¢ã€åˆ é™¤ä»»åŠ¡ï¼‰
- é¡µé¢é¦–æ¬¡åŠ è½½

**å¢é‡æ›´æ–°åœºæ™¯ï¼š**

- ä»»åŠ¡è¿›åº¦å˜åŒ–
- ä»»åŠ¡çŠ¶æ€åœ¨åŒä¸€ç»„å†…å˜åŒ–ï¼ˆå¦‚ä»ç­‰å¾…å˜ä¸ºä¸‹è½½ä¸­ï¼‰

#### 2. é˜²æŠ–å¤„ç†

```kotlin
class DownloadListManager {

    // è¿›åº¦æ›´æ–°é˜²æŠ–
    private val lastProgressUpdateTimeMap = mutableMapOf<String, Long>()
    private val progressUpdateInterval = 300L // 300msé˜²æŠ–é—´éš”

    private fun updateTaskProgress(taskId: String, progress: Int, speed: Long) {
        val now = System.currentTimeMillis()
        val lastUpdateTime = lastProgressUpdateTimeMap[taskId] ?: 0L

        if (now - lastUpdateTime < progressUpdateInterval) {
            return // è·³è¿‡æ­¤æ¬¡æ›´æ–°
        }

        lastProgressUpdateTimeMap[taskId] = now
        // æ‰§è¡Œå®é™…çš„UIæ›´æ–°
        performProgressUpdate(taskId, progress, speed)
    }
}
```

#### 3. çŠ¶æ€åˆ†ç»„ç®¡ç†

```kotlin
class TaskListManager {

    private val downloading = mutableListOf<DownloadTask>()
    private val completed = mutableListOf<DownloadTask>()
    private val failed = mutableListOf<DownloadTask>()

    fun updateTask(task: DownloadTask) {
        val shouldBeInDownloading = task.status in listOf(
            DownloadStatus.DOWNLOADING,
            DownloadStatus.PAUSED,
            DownloadStatus.PENDING,
            DownloadStatus.WAITING
        )
        val shouldBeInCompleted = task.status == DownloadStatus.COMPLETED
        val shouldBeInFailed = task.status == DownloadStatus.FAILED

        val crossGroup = (downloading.contains(task) && shouldBeInCompleted) ||
                (completed.contains(task) && shouldBeInDownloading)

        if (crossGroup) {
            // è·¨ç»„å˜åŒ–ï¼Œéœ€è¦å…¨é‡åˆ·æ–°
            refreshAllLists()
        } else {
            // åŒç»„å†…å˜åŒ–ï¼Œå¢é‡æ›´æ–°
            updateSingleTask(task)
        }
    }

    private fun updateSingleTask(task: DownloadTask) {
        when {
            downloading.any { it.id == task.id } -> {
                val index = downloading.indexOfFirst { it.id == task.id }
                if (index >= 0) {
                    downloading[index] = task
                    downloadingAdapter.notifyItemChanged(index)
                }
            }
            completed.any { it.id == task.id } -> {
                val index = completed.indexOfFirst { it.id == task.id }
                if (index >= 0) {
                    completed[index] = task
                    completedAdapter.notifyItemChanged(index)
                }
            }
            // ... å…¶ä»–åˆ†ç»„
        }
    }
}
```

### ğŸ¨ UIæ›´æ–°æœ€ä½³å®è·µ

#### 1. æŒ‰é’®çŠ¶æ€ç®¡ç†

```kotlin
private fun bindButtonUI(task: DownloadTask) {
    when (task.status) {
        DownloadStatus.DOWNLOADING -> {
            button.text = "æš‚åœ"
            button.setProgress(task.progress)
            button.isEnabled = true
        }
        DownloadStatus.PAUSED -> {
            button.text = "ç»§ç»­"
            button.setProgress(task.progress)
            button.isEnabled = true
        }
        DownloadStatus.WAITING, DownloadStatus.PENDING -> {
            button.text = "ç­‰å¾…ä¸­"
            button.isEnabled = true
        }
        DownloadStatus.COMPLETED -> {
            button.text = "å®‰è£…"
            button.setProgress(100)
            button.isEnabled = true
        }
        DownloadStatus.FAILED -> {
            button.text = "é‡è¯•"
            button.isEnabled = true
        }
        else -> {
            button.text = "ä¸‹è½½"
            button.setProgress(0)
            button.isEnabled = true
        }
    }
}

// ä¹è§‚UIæ›´æ–°ç¤ºä¾‹
private fun handlePauseClick(task: DownloadTask) {
    when (task.status) {
        DownloadStatus.DOWNLOADING -> {
            // ç«‹å³æ›´æ–°UIï¼Œç„¶åè°ƒç”¨API
            val paused = task.copy(
                status = DownloadStatus.PAUSED, 
                speed = 0L, 
                updateTime = System.currentTimeMillis()
            )
            updateTaskInList(paused)
            DownloadManager.pause(task.id)
        }
        DownloadStatus.PAUSED -> {
            // ç«‹å³æ›´æ–°UIï¼Œç„¶åè°ƒç”¨API
            val resumed = task.copy(
                status = DownloadStatus.DOWNLOADING, 
                updateTime = System.currentTimeMillis()
            )
            updateTaskInList(resumed)
            DownloadManager.resume(task.id)
        }
    }
}
```

#### 2. è¿›åº¦æ˜¾ç¤ºä¼˜åŒ–

```kotlin
private fun updateProgressDisplay(task: DownloadTask, progress: Int, speed: Long) {
    // æ›´æ–°è¿›åº¦æ¡
    progressBar.progress = progress

    // æ›´æ–°é€Ÿåº¦æ˜¾ç¤ºï¼ˆæ ¼å¼åŒ–ï¼‰
    speedText.text = formatSpeed(speed)

    // æ›´æ–°å‰©ä½™æ—¶é—´
    val remainingTime = calculateRemainingTime(task.totalSize, task.currentSize, speed)
    timeText.text = formatTime(remainingTime)
}

private fun formatSpeed(bytesPerSecond: Long): String {
    return when {
        bytesPerSecond >= 1024 * 1024 -> "${bytesPerSecond / (1024 * 1024)} MB/s"
        bytesPerSecond >= 1024 -> "${bytesPerSecond / 1024} KB/s"
        else -> "$bytesPerSecond B/s"
    }
}
```

#### 3. é”™è¯¯å¤„ç†

```kotlin
private fun handleDownloadError(task: DownloadTask, error: DownloadError) {
    when (error) {
        DownloadError.NetworkError -> {
            showErrorDialog("ç½‘ç»œé”™è¯¯", "è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥åé‡è¯•")
        }
        DownloadError.StorageError -> {
            showErrorDialog("å­˜å‚¨ç©ºé—´ä¸è¶³", "è¯·æ¸…ç†å­˜å‚¨ç©ºé—´åé‡è¯•")
        }
        DownloadError.FileError -> {
            showErrorDialog("æ–‡ä»¶é”™è¯¯", "æ–‡ä»¶å¯èƒ½å·²æŸåï¼Œè¯·é‡æ–°ä¸‹è½½")
        }
        else -> {
            showErrorDialog("ä¸‹è½½å¤±è´¥", "æœªçŸ¥é”™è¯¯ï¼Œè¯·é‡è¯•")
        }
    }
}
```

### ğŸš€ æ€§èƒ½ä¼˜åŒ–å»ºè®®

#### 1. å†…å­˜ç®¡ç†

```kotlin
class DownloadActivity : AppCompatActivity() {

    private var flowListener: FlowDownloadListener? = null

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)

        // å»¶è¿Ÿåˆå§‹åŒ–ç›‘å¬å™¨
        flowListener = DownloadManager.flowListener
    }

    override fun onDestroy() {
        super.onDestroy()
        // Flowç›‘å¬å™¨ä¼šè‡ªåŠ¨ç®¡ç†ç”Ÿå‘½å‘¨æœŸï¼Œæ— éœ€æ‰‹åŠ¨æ¸…ç†
        flowListener = null
    }
}
```

#### 2. åˆ—è¡¨ä¼˜åŒ–

```kotlin
// ä½¿ç”¨ DiffUtil ä¼˜åŒ–åˆ—è¡¨æ›´æ–°
class DownloadTaskDiffCallback : DiffUtil.Callback() {
    override fun areItemsTheSame(oldItemPosition: Int, newItemPosition: Int): Boolean {
        return oldList[oldItemPosition].id == newList[newItemPosition].id
    }

    override fun areContentsTheSame(oldItemPosition: Int, newItemPosition: Int): Boolean {
        val oldTask = oldList[oldItemPosition]
        val newTask = newList[newItemPosition]
        return oldTask.status == newTask.status &&
                oldTask.progress == newTask.progress &&
                oldTask.speed == newTask.speed
    }
}
```

#### 3. ç½‘ç»œçŠ¶æ€ç›‘å¬

```kotlin
// ç›‘å¬ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œè‡ªåŠ¨æš‚åœ/æ¢å¤ä¸‹è½½
private fun setupNetworkListener() {
    NetStateReceiver(
        onNetConnected = { isWifi ->
            // ç½‘ç»œæ¢å¤æ—¶ï¼Œé€šçŸ¥ä¸‹è½½ç®¡ç†å™¨æ¢å¤ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡
            DownloadManager.onNetworkRestored()
        },
        onNetDisConnected = {
            // ç½‘ç»œæ–­å¼€æ—¶ï¼Œåªæš‚åœæ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡ï¼Œä¸å½±å“ç”¨æˆ·æ‰‹åŠ¨æš‚åœçš„ä»»åŠ¡
            DownloadManager.pauseAllForNetworkError()
        }
    ).register(this)
}
```

## ğŸŒ ç½‘ç»œç›‘å¬æœ€ä½³å®è·µ

### è®¾è®¡åŸåˆ™

ä¸‹è½½åº“ä¸å†å†…éƒ¨å¤„ç†ç½‘ç»œç›‘å¬ï¼Œè€Œæ˜¯å°†ç½‘ç»œç›‘å¬çš„è´£ä»»äº¤ç»™æ¥å…¥è€…ï¼Œè¿™æ ·è®¾è®¡æœ‰ä»¥ä¸‹ä¼˜åŠ¿ï¼š

1. **å®‰å…¨æ€§**ï¼šé¿å…ä¸‹è½½åº“å†…éƒ¨ç›‘å¬ç½‘ç»œçŠ¶æ€å¯èƒ½å¸¦æ¥çš„å®‰å…¨é£é™©
2. **çµæ´»æ€§**ï¼šæ¥å…¥è€…å¯ä»¥æ ¹æ®è‡ªå·±çš„ä¸šåŠ¡éœ€æ±‚è‡ªå®šä¹‰ç½‘ç»œç›‘å¬é€»è¾‘
3. **å¯æ§æ€§**ï¼šæ¥å…¥è€…å¯ä»¥æ§åˆ¶ä½•æ—¶æš‚åœ/æ¢å¤ä¸‹è½½ï¼Œé¿å…è¯¯æ“ä½œ

### ç½‘ç»œç›‘å¬å®ç°æ–¹å¼

#### 1. ä½¿ç”¨ ConnectivityManager.NetworkCallbackï¼ˆæ¨èï¼‰

```kotlin
class NetworkCallbackManager(private val context: Context) {
    
    private val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
    private val networkCallback = object : ConnectivityManager.NetworkCallback() {
        override fun onAvailable(network: Network) {
            // ç½‘ç»œæ¢å¤
            DownloadManager.onNetworkRestored()
        }
        
        override fun onLost(network: Network) {
            // ç½‘ç»œæ–­å¼€
            DownloadManager.pauseAllForNetworkError()
        }
    }
    
    fun startListening() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
            connectivityManager.registerDefaultNetworkCallback(networkCallback)
        }
    }
    
    fun stopListening() {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.N) {
            connectivityManager.unregisterNetworkCallback(networkCallback)
        }
    }
}
```

#### 2. ä½¿ç”¨ BroadcastReceiver

```kotlin
class NetworkStateReceiver : BroadcastReceiver() {
    
    private var onNetConnected: ((Boolean) -> Unit)? = null
    private var onNetDisConnected: (() -> Unit)? = null
    
    constructor(
        onNetConnected: (Boolean) -> Unit,
        onNetDisConnected: () -> Unit
    ) {
        this.onNetConnected = onNetConnected
        this.onNetDisConnected = onNetDisConnected
    }
    
    override fun onReceive(context: Context, intent: Intent) {
        if (intent.action == ConnectivityManager.CONNECTIVITY_ACTION) {
            val connectivityManager = context.getSystemService(Context.CONNECTIVITY_SERVICE) as ConnectivityManager
            val networkInfo = connectivityManager.activeNetworkInfo
            
            if (networkInfo != null && networkInfo.isConnected) {
                val isWifi = networkInfo.type == ConnectivityManager.TYPE_WIFI
                onNetConnected?.invoke(isWifi)
            } else {
                onNetDisConnected?.invoke()
            }
        }
    }
    
    fun register(context: Context) {
        val filter = IntentFilter(ConnectivityManager.CONNECTIVITY_ACTION)
        context.registerReceiver(this, filter)
    }
    
    fun unregister(context: Context) {
        context.unregisterReceiver(this)
    }
}
```

#### 3. ä½¿ç”¨ç¬¬ä¸‰æ–¹åº“

```kotlin
// ä½¿ç”¨ RxJava
RxNetwork.observeNetworkConnectivity(context)
    .subscribe { isConnected ->
        if (isConnected) {
            DownloadManager.onNetworkRestored()
        } else {
            DownloadManager.pauseAllForNetworkError()
        }
    }

// ä½¿ç”¨ LiveData
NetworkLiveData.getInstance(context).observe(this) { isConnected ->
    if (isConnected) {
        DownloadManager.onNetworkRestored()
    } else {
        DownloadManager.pauseAllForNetworkError()
    }
}
```

### ç½‘ç»œçŠ¶æ€æ£€æŸ¥API

ä¸‹è½½åº“æä¾›äº†ä¸°å¯Œçš„ç½‘ç»œçŠ¶æ€æ£€æŸ¥APIï¼š

```kotlin
// æ£€æŸ¥ç½‘ç»œæ˜¯å¦å¯ç”¨
val isNetworkAvailable = DownloadManager.isNetworkAvailable()

// æ£€æŸ¥WiFiæ˜¯å¦å¯ç”¨
val isWifiAvailable = DownloadManager.isWifiAvailable()

// æ£€æŸ¥ç§»åŠ¨ç½‘ç»œæ˜¯å¦å¯ç”¨
val isCellularAvailable = DownloadManager.isCellularAvailable()

// è·å–ç½‘ç»œç±»å‹
val networkType = DownloadManager.getNetworkType() // "WiFi", "Cellular", "Ethernet", "Unknown", "No Network"

// æ£€æŸ¥æ˜¯å¦ä¸ºè®¡è´¹ç½‘ç»œ
val isMetered = DownloadManager.isMeteredNetwork()
```

### ç½‘ç»œæ¢å¤API

```kotlin
// æ‰‹åŠ¨è§¦å‘ç½‘ç»œæ¢å¤æ£€æŸ¥
DownloadManager.onNetworkRestored()

// è·å–å› ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡æ•°é‡
val networkPausedCount = DownloadManager.getNetworkPausedTaskCount()

// è·å–å› ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡åˆ—è¡¨
val networkPausedTasks = DownloadManager.getNetworkPausedTasks()
```

## â¸ï¸ æš‚åœåŸå› ç®¡ç†

### æš‚åœåŸå› ç±»å‹

ä¸‹è½½åº“æ”¯æŒä¸‰ç§æš‚åœåŸå› ï¼š

```kotlin
enum class PauseReason {
    USER_MANUAL,      // ç”¨æˆ·æ‰‹åŠ¨æš‚åœ
    NETWORK_ERROR,    // ç½‘ç»œå¼‚å¸¸æš‚åœ
    STORAGE_FULL      // å­˜å‚¨ç©ºé—´ä¸è¶³æš‚åœ
}
```

### æš‚åœåŸå› çš„åŒºåˆ«

1. **USER_MANUAL**ï¼šç”¨æˆ·ä¸»åŠ¨æš‚åœçš„ä»»åŠ¡ï¼Œä¸ä¼šè‡ªåŠ¨æ¢å¤
2. **NETWORK_ERROR**ï¼šå› ç½‘ç»œæ–­å¼€æš‚åœçš„ä»»åŠ¡ï¼Œç½‘ç»œæ¢å¤åä¼šè‡ªåŠ¨æ¢å¤
3. **STORAGE_FULL**ï¼šå› å­˜å‚¨ç©ºé—´ä¸è¶³æš‚åœçš„ä»»åŠ¡ï¼Œç©ºé—´æ¢å¤åä¼šè‡ªåŠ¨æ¢å¤

### æš‚åœåŸå› çš„ä½¿ç”¨

```kotlin
// ç”¨æˆ·æ‰‹åŠ¨æš‚åœ
DownloadManager.pause(taskId) // é»˜è®¤ä½¿ç”¨ USER_MANUAL

// æŒ‡å®šæš‚åœåŸå› 
DownloadManager.pauseTask(taskId, PauseReason.USER_MANUAL)

// ç½‘ç»œæ–­å¼€æ—¶æš‚åœæ‰€æœ‰æ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡
DownloadManager.pauseAllForNetworkError()

// æ‰¹é‡æš‚åœå¹¶æŒ‡å®šåŸå› 
DownloadManager.pauseAll(PauseReason.STORAGE_FULL)
```

### æ–­ç½‘å¤„ç†ç­–ç•¥

æ¨èçš„å¤„ç†æ–¹å¼ï¼š

```kotlin
// ç½‘ç»œæ–­å¼€æ—¶
DownloadManager.pauseAllForNetworkError() // åªæš‚åœæ­£åœ¨ä¸‹è½½çš„ä»»åŠ¡

// ç½‘ç»œæ¢å¤æ—¶
DownloadManager.onNetworkRestored() // è‡ªåŠ¨æ¢å¤ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡
```

**ä¼˜åŠ¿**ï¼š
- ä¸å½±å“ç”¨æˆ·æ‰‹åŠ¨æš‚åœçš„ä»»åŠ¡
- è‡ªåŠ¨æ¢å¤å› ç½‘ç»œå¼‚å¸¸æš‚åœçš„ä»»åŠ¡
- æä¾›æ›´å¥½çš„ç”¨æˆ·ä½“éªŒ

## ğŸ“ æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ¥å…¥æ–‡æ¡£å’Œæœ€ä½³å®è·µï¼Œä½ å¯ä»¥ï¼š

1. **å¿«é€Ÿé›†æˆ**ï¼šæŒ‰ç…§æ–‡æ¡£æ­¥éª¤å¿«é€Ÿé›†æˆä¸‹è½½ç®¡ç†å™¨
2. **é«˜æ•ˆç›‘å¬**ï¼šä½¿ç”¨Flowç›‘å¬å™¨å®ç°å“åº”å¼UIæ›´æ–°
3. **ä¼˜åŒ–æ€§èƒ½**ï¼šé€šè¿‡é˜²æŠ–ã€åˆ†ç»„ç®¡ç†ç­‰ç­–ç•¥ä¼˜åŒ–åˆ—è¡¨åˆ·æ–°æ€§èƒ½
4. **æå‡ä½“éªŒ**ï¼šé€šè¿‡åˆç†çš„çŠ¶æ€ç®¡ç†å’Œé”™è¯¯å¤„ç†æå‡ç”¨æˆ·ä½“éªŒ
5. **ç½‘ç»œç®¡ç†**ï¼šçµæ´»å¤„ç†ç½‘ç»œçŠ¶æ€å˜åŒ–ï¼Œæä¾›æ™ºèƒ½çš„æš‚åœ/æ¢å¤æœºåˆ¶
6. **çŠ¶æ€ç®¡ç†**ï¼šåˆç†ä½¿ç”¨æš‚åœåŸå› ï¼Œæä¾›ç²¾ç¡®çš„ä»»åŠ¡çŠ¶æ€æ§åˆ¶

è¿™ä¸ªä¸‹è½½ç®¡ç†å™¨æä¾›äº†ä¼ä¸šçº§çš„åŠŸèƒ½ç‰¹æ€§ï¼Œæ”¯æŒå¤šçº¿ç¨‹åˆ†ç‰‡ä¸‹è½½ã€æ–­ç‚¹ç»­ä¼ ã€ä¼˜å…ˆçº§è°ƒåº¦ç­‰ï¼Œèƒ½å¤Ÿæ»¡è¶³å„ç§å¤æ‚çš„ä¸‹è½½åœºæ™¯éœ€æ±‚ã€‚
