# ä»»åŠ¡æŒä¹…åŒ–ç¼ºé™·æ·±åº¦åˆ†ææŠ¥å‘Š

## ğŸš¨ è‡´å‘½ç¼ºé™·ï¼šä»»åŠ¡æ·»åŠ åæœªæŒä¹…åŒ–

### 1. é—®é¢˜æ ¸å¿ƒ

**ä»»åŠ¡æ·»åŠ åä»…å­˜åœ¨äºå†…å­˜ï¼Œæœªå†™å…¥æ•°æ®åº“ï¼**

### 2. å…·ä½“ç¼ºé™·åˆ†æ

#### 2.1 ä»»åŠ¡æ·»åŠ æµç¨‹ç¼ºé™·

**å½“å‰æµç¨‹**ï¼š
```
DownloadTask.pushTask()
    â†“
DownloadQueueDispatcher.pushTask() [ä»…å†…å­˜æ“ä½œ]
    â†“
allActivatedDownloadCall.add(call) [å†…å­˜åˆ—è¡¨]
    â†“
startNextTaskIfAvailable() [å†…å­˜è°ƒåº¦]
```

**ç¼ºå¤±ç¯èŠ‚**ï¼š
```
âŒ ä»»åŠ¡æ·»åŠ æ—¶æœªå†™å…¥æ•°æ®åº“
âŒ ä»»åŠ¡çŠ¶æ€å˜æ›´æœªåŒæ­¥åˆ°æ•°æ®åº“
âŒ è¿›ç¨‹è¢«æ€åä»»åŠ¡å®Œå…¨ä¸¢å¤±
âŒ é‡å¯åæ— æ³•æ¢å¤ç­‰å¾…ä¸­çš„ä»»åŠ¡
```

#### 2.2 ä»£ç éªŒè¯

**DownloadQueueDispatcher.pushTask()** (å…³é”®ç¼ºé™·ä½ç½®):
```kotlin
// åªåšäº†å†…å­˜æ“ä½œï¼Œæ²¡æœ‰ä»»ä½•æ•°æ®åº“å†™å…¥
fun pushTask(task: DownloadTask) {
    launch {
        mutexLock.withLock {
            if (!isTaskExists(task.getTaskId())) {
                task.downloadInfo?.status = DownloadStatus.WAITING  // åªåœ¨å†…å­˜ä¸­è®¾ç½®
                val call = DownloadMultiCall(task).setListener(mDownloadListenerWrap)
                allActivatedDownloadCall.add(call)  // åªåœ¨å†…å­˜ä¸­æ·»åŠ 
                // âŒ ç¼ºå¤±ï¼šæ²¡æœ‰å†™å…¥æ•°æ®åº“
                startNextTaskIfAvailable()
            }
        }
    }
}
```

**DownloadMultiCall.startCall()** (å»¶è¿ŸæŒä¹…åŒ–ç¼ºé™·):
```kotlin
// åªåœ¨å¼€å§‹ä¸‹è½½æ—¶æ‰åˆ›å»ºæ–­ç‚¹è®°å½•
private suspend fun getOrCreateBreakpointData(...): DownloadBreakPointData {
    val existingInfo = DownloadBreakPointManger.queryByTaskId(taskId)
    return if (existingInfo != null) {
        existingInfo  // å¦‚æœä¹‹å‰æ²¡æœ‰è®°å½•ï¼Œè¿™é‡Œè¿”å›null
    } else {
        val newInfo = DownloadBreakPointData(...)
        DownloadBreakPointManger.upsert(newInfo)  // âŒ åªåœ¨å¼€å§‹ä¸‹è½½æ—¶æ‰å†™å…¥
        newInfo
    }
}
```

### 3. è¿›ç¨‹è¢«æ€åœºæ™¯åˆ†æ

#### 3.1 åœºæ™¯1ï¼šä»»åŠ¡åˆšæ·»åŠ æœªå¼€å§‹
```
ç”¨æˆ·æ·»åŠ ä»»åŠ¡ â†’ è¿›ç¨‹è¢«æ€ â†’ é‡å¯åº”ç”¨ â†’ ä»»åŠ¡å®Œå…¨æ¶ˆå¤±
```

#### 3.2 åœºæ™¯2ï¼šä»»åŠ¡ç­‰å¾…ä¸­
```
ä»»åŠ¡æ·»åŠ  â†’ é˜Ÿåˆ—æ’é˜Ÿç­‰å¾… â†’ è¿›ç¨‹è¢«æ€ â†’ é‡å¯åä»»åŠ¡ä¸¢å¤±
```

#### 3.3 åœºæ™¯3ï¼šä¸‹è½½ä¸­çŠ¶æ€ä¸¢å¤±
```
ä»»åŠ¡å¼€å§‹ä¸‹è½½ â†’ å·²åˆ›å»ºæ–­ç‚¹è®°å½• â†’ è¿›ç¨‹è¢«æ€ â†’ 
é‡å¯ååªèƒ½çœ‹åˆ°"ä¸‹è½½ä¸­"çŠ¶æ€ï¼Œä½†ä»»åŠ¡ä¸åœ¨è°ƒåº¦å™¨ä¸­
```

### 4. æ•°æ®æ¢å¤æœºåˆ¶ç¼ºé™·

**Downloader.queryAllTasksFromCache()** åªèƒ½æ¢å¤å·²æœ‰æ–­ç‚¹è®°å½•çš„ä»»åŠ¡ï¼š
```kotlin
// åªèƒ½æ¢å¤æ›¾ç»å¼€å§‹ä¸‹è½½è¿‡çš„ä»»åŠ¡
suspend fun queryAllTasksFromCache(): MutableList<DownloadTask> {
    val breakPointList = DownloadBreakPointManger.queryAll()  // å¯èƒ½ä¸ºç©º
    // âŒ æ— æ³•æ¢å¤ç­‰å¾…ä¸­çš„ä»»åŠ¡ï¼ˆå› ä¸ºæ²¡æœ‰æ–­ç‚¹è®°å½•ï¼‰
}
```

### 5. ä¿®å¤æ–¹æ¡ˆ

#### 5.1 ç«‹å³ä¿®å¤ - æ·»åŠ ä»»åŠ¡æŒä¹…åŒ–

```kotlin
// DownloadQueueDispatcher.kt
fun pushTask(task: DownloadTask) {
    launch {
        mutexLock.withLock {
            if (!isTaskExists(task.getTaskId())) {
                // 1. ç«‹å³æŒä¹…åŒ–ä»»åŠ¡ä¿¡æ¯
                saveTaskToDatabase(task)
                
                task.downloadInfo?.status = DownloadStatus.WAITING
                val call = DownloadMultiCall(task).setListener(mDownloadListenerWrap)
                allActivatedDownloadCall.add(call)
                startNextTaskIfAvailable()
            }
        }
    }
}

private suspend fun saveTaskToDatabase(task: DownloadTask) {
    val info = DownloadBreakPointData(
        taskId = task.getTaskId(),
        url = task.getUrl(),
        filePath = task.getFilePath(),
        fileName = task.getFileName(),
        currentLength = 0,
        totalLength = 0, // æœªçŸ¥ï¼Œåç»­æ›´æ–°
        status = DownloadStatus.WAITING,
        createTime = System.currentTimeMillis(),
        updateTime = System.currentTimeMillis()
    )
    DownloadBreakPointManger.upsert(info)
}
```

#### 5.2 çŠ¶æ€åŒæ­¥ä¿®å¤

```kotlin
// æ¯æ¬¡çŠ¶æ€å˜æ›´éƒ½åŒæ­¥åˆ°æ•°æ®åº“
private suspend fun updateTaskStatus(taskId: String, status: Int) {
    // æ›´æ–°å†…å­˜çŠ¶æ€
    val task = getTask(taskId)
    task?.downloadInfo?.status = status
    
    // æ›´æ–°æ•°æ®åº“çŠ¶æ€
    val breakpoint = DownloadBreakPointManger.queryByTaskId(taskId)
    breakpoint?.let {
        it.status = status
        it.updateTime = System.currentTimeMillis()
        DownloadBreakPointManger.upsert(it)
    }
}
```

#### 5.3 å®Œæ•´ä»»åŠ¡æ¢å¤

```kotlin
// æ¢å¤æ‰€æœ‰ä»»åŠ¡ï¼ˆåŒ…æ‹¬ç­‰å¾…ä¸­çš„ï¼‰
suspend fun restoreAllTasks(): MutableList<DownloadTask> {
    val allTasks = DownloadBreakPointManger.queryAll() ?: return mutableListOf()
    
    return allTasks.map { info ->
        DownloadTask.create {
            taskId = info.taskId
            url = info.url
            progress = info.progress
            status = info.status
            fileName = info.fileName
            filePath = info.filePath
            totalLength = info.totalLength
            currentLength = info.currentLength
            tag = info.tag
            extra = info.extra
        }
    }.toMutableList()
}
```

### 6. æ•°æ®æµé‡æ„

#### 6.1 æ–°çš„æ•°æ®æµ
```
ä»»åŠ¡æ·»åŠ 
    â†“
ç«‹å³å†™å…¥æ•°æ®åº“ (WAITINGçŠ¶æ€)
    â†“
æ·»åŠ åˆ°å†…å­˜è°ƒåº¦å™¨
    â†“
è¿›ç¨‹è¢«æ€ â†’ é‡å¯åæ¢å¤
    â†“
ç»§ç»­è°ƒåº¦æ‰§è¡Œ
```

#### 6.2 çŠ¶æ€åŒæ­¥æœºåˆ¶
```kotlin
// ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†
sealed class DownloadState {
    data class Added(val task: DownloadTask) : DownloadState()
    data class Waiting(val task: DownloadTask) : DownloadState()
    data class Downloading(val task: DownloadTask) : DownloadState()
    data class Paused(val task: DownloadTask) : DownloadState()
    data class Completed(val task: DownloadTask) : DownloadState()
    data class Failed(val task: DownloadTask, val error: Throwable) : DownloadState()
}

// æ¯æ¬¡çŠ¶æ€å˜æ›´éƒ½æŒä¹…åŒ–
suspend fun updateState(state: DownloadState) {
    when (state) {
        is DownloadState.Added -> saveTask(state.task)
        is DownloadState.Waiting -> updateTaskStatus(state.task, DownloadStatus.WAITING)
        is DownloadState.Downloading -> updateTaskStatus(state.task, DownloadStatus.DOWNLOADING)
        // ... å…¶ä»–çŠ¶æ€
    }
}
```

### 7. ç´§æ€¥ä¿®å¤æ¸…å•

#### 7.1 ç«‹å³ä¿®å¤
- [ ] `pushTask()`æ–¹æ³•ä¸­æ·»åŠ ä»»åŠ¡æŒä¹…åŒ–
- [ ] æ¯æ¬¡çŠ¶æ€å˜æ›´åŒæ­¥åˆ°æ•°æ®åº“
- [ ] åº”ç”¨å¯åŠ¨æ—¶æ¢å¤æ‰€æœ‰ä»»åŠ¡

#### 7.2 å®Œæ•´æ€§ä¿è¯
- [ ] æ·»åŠ æ•°æ®åº“äº‹åŠ¡æ”¯æŒ
- [ ] å®ç°çŠ¶æ€æœºç®¡ç†
- [ ] æ·»åŠ æ•°æ®ä¸€è‡´æ€§éªŒè¯

#### 7.3 æµ‹è¯•åœºæ™¯
- [ ] ä»»åŠ¡æ·»åŠ åç«‹å³æ€è¿›ç¨‹ï¼Œé‡å¯åä»»åŠ¡å­˜åœ¨
- [ ] ç­‰å¾…ä¸­çš„ä»»åŠ¡æ€è¿›ç¨‹åæ¢å¤
- [ ] ä¸‹è½½ä¸­çš„ä»»åŠ¡æ€è¿›ç¨‹åæ¢å¤çŠ¶æ€
- [ ] å¹¶å‘æ·»åŠ ä»»åŠ¡çš„æ•°æ®ä¸€è‡´æ€§

## ğŸ”¥ ç»“è®º

è¿™æ˜¯**æ¶æ„çº§ç¼ºé™·**ï¼å½“å‰å®ç°å°†æ‰€æœ‰ä»»åŠ¡ä»…ä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œå®Œå…¨è¿èƒŒäº†ä¸‹è½½ç®¡ç†å™¨çš„åŸºæœ¬èŒè´£ã€‚å¿…é¡»ç«‹å³é‡æ„ä»»åŠ¡æŒä¹…åŒ–æœºåˆ¶ã€‚